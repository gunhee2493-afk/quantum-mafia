<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–‘ì ë§ˆí”¼ì•„: ì—ì´ì˜¨ ì¹¨ëµì „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, serverTimestamp, runTransaction, deleteDoc, getDocs, query, where, writeBatch, deleteField, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        let db, auth;
        let localPlayer = { id: null, nickname: null, number: null, isHost: false };
        let currentRoomId = null;
        let currentRoomData = null;
        let roomUnsubscribe = null; 
        let roomListUnsubscribe = null;
        let gameTimerInterval = null;
        let isDevMode = false;
        let actingBotId = null;
        let selectedGameMode = 'classic';
        let myInitialRoleForReveal = null;

        // --- ì¹´ë“œ ì •ì˜ ---
        const abilityCardDeck = {
            'info_trace': { name: 'ì•”í˜¸ í•´ë…ê¸°', description: 'ë‚® í† ë¡  ì¢…ë£Œ ì§ì „ ì‚¬ìš©í•˜ì—¬, ë‹¤ê°€ì˜¤ëŠ” ë°¤ì˜ ëª¨ë“  ëŠ¥ë ¥ ì‚¬ìš© ê²°ê³¼ë¥¼ í˜¼ìë§Œ í™•ì¸í•©ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'info', needsTarget: false },
            'info_heisenberg': { name: 'í•˜ì´ì  ë² ë¥´í¬ ê´€ì¸¡ê¸°', description: 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ 1ëª…ì˜ ìƒíƒœíŒì„ ì •í™•í•˜ê²Œ í™•ì¸í•˜ëŠ” ëŒ€ê°€(ë¶ˆí™•ì •ì„± ì›ë¦¬)ë¡œ, ìì‹ ì˜ ìƒíƒœíŒ ì¹© í•˜ë‚˜ê°€ ë¬´ì‘ìœ„ë¡œ ë°˜ëŒ€ ìƒ‰ìœ¼ë¡œ ë’¤ì§‘í™ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'info', needsTarget: true },
            'state_infect': { name: 'ë°ì´í„° ì˜¤ì—¼', description: 'ë‚® í† ë¡  ì‹œê°„ì— ìì‹ ì„ í¬í•¨í•œ 1ëª…ì˜ íŒŒë€ ì¹© 1ê°œë¥¼ ë¹¨ê°„ ì¹©ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'state', needsTarget: true },
            'state_heal': { name: 'ë°ì´í„° ë³µêµ¬', description: 'ë‚® í† ë¡  ì‹œê°„ì— ìì‹ ì„ í¬í•¨í•œ 1ëª…ì˜ ë¹¨ê°„ ì¹© 1ê°œë¥¼ íŒŒë€ ì¹©ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'state', needsTarget: true },
            'state_scramble': { name: 'ì‹ ë¶„ êµë€ ì¥ì¹˜', description: 'ìµœì¢… ì¸¡ì • ì§ì „ì— ì‚¬ìš©í•˜ì—¬, ë‹¤ë¥¸ í”Œë ˆì´ì–´ 1ëª…ê³¼ ìì‹ ì˜ ìƒíƒœíŒ ì „ì²´ë¥¼ ë§ë°”ê¿‰ë‹ˆë‹¤.', timing: 'OBSERVATION', type: 'state', needsTarget: true },
            'state_host': { name: 'ìˆ™ì£¼ í”„ë¡œí† ì½œ', description: '(íŒ¨ì‹œë¸Œ) ë‚® íˆ¬í‘œ ì¢…ë£Œ ì‹œ ì—ì´ì˜¨ì´ ì—†ìœ¼ë©´, ìì‹ ì´ ì—ì´ì˜¨ì´ ë˜ê³  ë°¤ì— 2ëª…ì„ ê°ì—¼ì‹œí‚µë‹ˆë‹¤.', timing: 'PASSIVE', type: 'state', needsTarget: false },
            'power_latent': { name: 'ì ì¬ëœ í˜', description: '(íŒ¨ì‹œë¸Œ) ìì‹ ì´ ë°±ì‹  ê°œë°œìë‚˜ ì—ì´ì˜¨ì´ ë˜ë©´, ë°¤ ëŠ¥ë ¥ ì‚¬ìš© ì‹œ 2ëª…ì„ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì—ì´ì˜¨ì€ í•œ ëª…ì—ê²Œ ì¤‘ë³µ ê°ì—¼ ê°€ëŠ¥)', timing: 'PASSIVE', type: 'state', needsTarget: false }, 
            'rule_entangle': { name: 'ì–‘ì ì–½í˜', description: 'ë‚® í† ë¡  ì‹œê°„ì— ë‹¤ë¥¸ í”Œë ˆì´ì–´ 1ëª…ê³¼ ìì‹ ì„ ê³µê°œì ìœ¼ë¡œ ì–½ìŠµë‹ˆë‹¤. ê²Œì„ ì¢…ë£Œ ì‹œ ë‘˜ì€ ë°˜ë“œì‹œ ë°˜ëŒ€ ì§„ì˜ì´ ë©ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'rule', needsTarget: true },
            'rule_remeasure': { name: 'ì¸ê³¼ìœ¨ êµë€ê¸°', description: 'ìì‹ ì˜ ìµœì¢… ìš´ëª… ì¸¡ì • ê²°ê³¼ê°€ ë§ˆìŒì— ë“¤ì§€ ì•Šìœ¼ë©´, 1íšŒì— í•œí•´ ì¬ì¸¡ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', timing: 'MEASUREMENT', type: 'rule', needsTarget: false },
            'rule_firewall': { name: 'ë°©í™”ë²½', description: 'ë‚® í† ë¡  ì‹œê°„ì— ì‚¬ìš©í•˜ì—¬, ë‹¤ê°€ì˜¤ëŠ” ë°¤ ë™ì•ˆ ëª¨ë“  í”Œë ˆì´ì–´ë¥¼ ê°ì—¼ìœ¼ë¡œë¶€í„° ë³´í˜¸í•©ë‹ˆë‹¤.', timing: 'DISCUSSION', type: 'rule', needsTarget: false },
        };

        // --- ì‚¬ìš´ë“œ ì—”ì§„ ---
        let sounds;
        function initializeSounds() {
            sounds = {
                click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
                popupOpen: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination(),
                gameStart: new Tone.Synth({ oscillator: { type: "fmtriangle", modulationType: "sawtooth", modulationIndex: 2 }, envelope: { attack: 0.1, decay: 0.4, sustain: 0.5, release: 0.8 } }).toDestination(),
                phaseChange: new Tone.AMSynth().toDestination(),
                timerTick: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.01 } }).toDestination(),
                roleReveal: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
                cardEffect: new Tone.PluckSynth({ attackNoise: 1, dampening: 4000, resonance: 0.7 }).toDestination(),
            };
        }
        function playSound(soundName) {
            if (!sounds) return;
            try {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                const now = Tone.now();
                switch(soundName) {
                    case 'click': sounds.click.triggerAttackRelease("C5", "8n", now); break;
                    case 'popupOpen': sounds.popupOpen.triggerAttackRelease("G4", "8n", now); break;
                    case 'gameStart': sounds.gameStart.triggerAttackRelease("C4", "2n", now); break;
                    case 'phaseChange': sounds.phaseChange.triggerAttackRelease("C3", "1n", now); break;
                    case 'timerTick': sounds.timerTick.triggerAttackRelease("C2", "8n", now); break;
                    case 'roleReveal': sounds.roleReveal.triggerAttackRelease("4n", now); break;
                    case 'cardEffect': sounds.cardEffect.triggerAttackRelease("G5", "2n", now); break;
                }
            } catch (e) { console.error("Sound play error:", e); }
        }

        // --- ëª¨ë“  í•¨ìˆ˜ ì •ì˜ ---

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const screenToShow = document.getElementById(screenId);
            if(screenToShow) {
                screenToShow.classList.remove('hidden');
                if (screenId !== 'game-screen') playSound('popupOpen');
            }
        }

        function setNicknameAndShowMain() {
            playSound('click');
            const nicknameInput = document.getElementById('nickname-input');
            const nickname = nicknameInput.value.trim();
            if (nickname && nickname.length > 0 && nickname.length <= 10) {
                localPlayer.nickname = nickname;
                showScreen('main-menu-screen');
            } else {
                showCustomAlert('ë‹‰ë„¤ì„ì€ 1~10ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function showCreateRoomPopup() { 
            playSound('popupOpen');
            document.getElementById('create-room-popup').classList.remove('hidden'); 
        }
        function hideCreateRoomPopup() { 
            playSound('click');
            document.getElementById('create-room-popup').classList.add('hidden'); 
        }
        
        function showRulebookPopup() {
            playSound('popupOpen');
            document.getElementById('rulebook-popup').classList.remove('hidden');
        }
        function hideRulebookPopup() {
            playSound('click');
            document.getElementById('rulebook-popup').classList.add('hidden');
        }

        function showConfirmLeavePopup() {
            playSound('popupOpen');
            const popup = document.getElementById('confirm-leave-popup');
            const warningText = document.getElementById('leave-warning-text');
            if (localPlayer.isHost) {
                warningText.innerText = 'í˜¸ìŠ¤íŠ¸ê°€ ë°©ì„ ë‚˜ê°€ë©´ ë°©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.';
                warningText.classList.remove('hidden');
            } else {
                warningText.classList.add('hidden');
            }
            popup.classList.remove('hidden');
        }
        function hideConfirmLeavePopup() {
            playSound('click');
            document.getElementById('confirm-leave-popup').classList.add('hidden');
        }

        function showEventLogPopup() {
            const room = currentRoomData;
            if (!room || !room.eventLog) return;
            const logContentEl = document.getElementById('event-log-content');
            logContentEl.innerHTML = [...room.eventLog].reverse().map(log => {
                const text = (localPlayer.isHost || !log.playerText) ? log.hostText : log.playerText;
                let icon = '';
                if (log.phase === 'ë‚®') icon = 'ğŸŒ';
                if (log.phase === 'ë°¤') icon = 'ğŸŒš';
                return `<div class="border-b border-cyan-500/20 py-2">
                            <p class="font-bold text-orange-400">${log.round}ë¼ìš´ë“œ ${log.phase}</p>
                            <p>${icon} ${text}</p>
                        </div>`
            }).join('');
            document.getElementById('event-log-popup').classList.remove('hidden');
            playSound('popupOpen');
        }

        function hideEventLogPopup() {
            playSound('click');
            document.getElementById('event-log-popup').classList.add('hidden');
        }


        function showRoomList(gameMode) {
            showScreen('room-list-screen');
            const roomListEl = document.getElementById('room-list-container');
            roomListEl.innerHTML = '<div class="text-white text-center">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            if (roomListUnsubscribe) roomListUnsubscribe();

            const q = query(collection(db, 'rooms'), where("status", "==", "waiting"), where("gameMode", "==", gameMode));
            roomListUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    roomListEl.innerHTML = '<div class="text-white text-center">ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                roomListEl.innerHTML = snapshot.docs.map(doc => {
                    const room = doc.data();
                    if (!room.players || !room.host) return '';
                    const playerCount = Object.keys(room.players).length;
                    return `
                        <div class="screen-panel-item flex justify-between items-center" onclick="joinRoom('${doc.id}', ${room.hasPassword})">
                            <div>
                                <h3 class="text-lg font-bold text-cyan-300 font-orbitron">${room.name}</h3>
                                <p class="text-gray-400">í˜¸ìŠ¤íŠ¸: ${room.host.nickname}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                ${room.hasPassword ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-yellow-500"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>` : ''}
                                <span class="text-xl font-bold text-cyan-400">${playerCount}/12</span>
                            </div>
                        </div>`;
                }).join('');
            }, (error) => {
                console.error("Error getting real-time room list:", error);
                roomListEl.innerHTML = '<div class="text-white text-center">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }
        
        async function createRoom() {
            playSound('click');
            const roomName = document.getElementById('room-name-input').value.trim();
            const password = document.getElementById('password-input').value.trim();
            if (!roomName) { showCustomAlert('ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            try {
                if (roomListUnsubscribe) {
                    roomListUnsubscribe();
                    roomListUnsubscribe = null;
                }
                const roomRef = doc(collection(db, 'rooms'));
                currentRoomId = roomRef.id;
                localPlayer.isHost = true;
                
                const newRoom = {
                    name: roomName, password, hasPassword: password.length > 0,
                    host: { id: localPlayer.id, nickname: localPlayer.nickname },
                    players: {}, 
                    status: 'waiting', createdAt: serverTimestamp(), 
                    gameMode: selectedGameMode,
                    totalRounds: 4, // ë¼ìš´ë“œ ì„¤ì • ê¸°ë³¸ê°’
                    minPlayers: isDevMode ? 1 : 4,
                    maxPlayers: 12,
                    eventLog: []
                };
                await setDoc(roomRef, newRoom);
                hideCreateRoomPopup();
                
                subscribeToRoom(currentRoomId);
                showScreen('lobby-screen');

            } catch (error) { console.error("Error creating room:", error); showCustomAlert('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }
        
        async function joinRoom(roomId, hasPassword) {
            playSound('click');
            localPlayer.isHost = false;
            
            if (hasPassword) {
                const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (password === null) return;

                const roomRef = doc(db, 'rooms', roomId);
                const roomDoc = await getDoc(roomRef);
                if(roomDoc.exists() && roomDoc.data().password !== password) {
                    showCustomAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.');
                    return;
                }
            }
            try {
                if (roomListUnsubscribe) {
                    roomListUnsubscribe(); 
                    roomListUnsubscribe = null;
                }
                
                showScreen('lobby-screen');
                
                await runTransaction(db, async (transaction) => {
                    const roomRef = doc(db, 'rooms', roomId);
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    const room = roomDoc.data();
                    const playerCount = Object.keys(room.players).length;
                    if (playerCount >= 12) throw new Error("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
                    if (room.status !== 'waiting') throw new Error("ì´ë¯¸ ì‹œì‘ëœ ê²Œì„ì…ë‹ˆë‹¤.");
                    
                    const existingNumbers = Object.values(room.players).map(p => p.number);
                    let newPlayerNumber = 1;
                    while(existingNumbers.includes(newPlayerNumber)) { newPlayerNumber++; }

                    localPlayer.number = newPlayerNumber;
                    const newPlayerData = { 
                        id: localPlayer.id, 
                        nickname: localPlayer.nickname, 
                        isReady: false,
                        number: newPlayerNumber, 
                        isAlive: true, 
                        initialRole: null, 
                        currentRole: null, 
                        quantumState: [], 
                        finalRole: null,
                        abilityCard: null,
                        hasUsedCard: false
                    };
                    transaction.update(roomRef, { [`players.${localPlayer.id}`]: newPlayerData });
                });

                currentRoomId = roomId;
                subscribeToRoom(roomId);
            } catch (error) { 
                console.error("Error joining room:", error); 
                showCustomAlert(`ë°© ì°¸ê°€ ì‹¤íŒ¨: ${error.message}`);
                showScreen('main-menu-screen');
            }
        }

        function resetLocalState() {
            if (roomUnsubscribe) roomUnsubscribe();
            if (roomListUnsubscribe) roomListUnsubscribe();
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            
            roomUnsubscribe = null;
            roomListUnsubscribe = null;
            gameTimerInterval = null;
            currentRoomId = null; 
            localPlayer.number = null;
            localPlayer.isHost = false;
            currentRoomData = null;
            actingBotId = null;
        }

        function subscribeToRoom(roomId) {
            const roomRef = doc(db, 'rooms', roomId);
            if (roomUnsubscribe) roomUnsubscribe();
            roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const oldRoomData = currentRoomData;
                    currentRoomData = doc.data();
                    
                    const amIHost = auth.currentUser && currentRoomData.host.id === auth.currentUser.uid;
                    if (amIHost) localPlayer.isHost = true;
                    const amIPlayer = currentRoomData.players[localPlayer.id];
                    
                    if (!amIHost && !amIPlayer) {
                        console.log("Not involved in this room. No UI updates.");
                        return;
                    }
                    
                    // --- ì¹´ë“œ ì‚¬ìš© ì‹œê° íš¨ê³¼ ì²˜ë¦¬ ---
                    if (currentRoomData.gameState?.lastSpecialEffect && JSON.stringify(currentRoomData.gameState?.lastSpecialEffect) !== JSON.stringify(oldRoomData?.gameState?.lastSpecialEffect)) {
                        const effect = currentRoomData.gameState.lastSpecialEffect;
                        const card = abilityCardDeck[effect.cardId];
                        showCardUseEffect(card.name, `${effect.userNickname} ë‹˜ì´ ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`);
                        if (localPlayer.isHost) {
                            setTimeout(() => {
                                updateDoc(roomRef, { 'gameState.lastSpecialEffect': deleteField() });
                            }, 100);
                        }
                    }

                    // ê²Œì„ ì‹œì‘ ì‹œ ì—­í•  ê³µê°œ ì—°ì¶œ
                    if (currentRoomData.status === 'playing' && oldRoomData?.status === 'waiting') {
                         if(gameTimerInterval) clearInterval(gameTimerInterval);
                         if (amIPlayer) {
                             myInitialRoleForReveal = currentRoomData.players[localPlayer.id].initialRole;
                             showRoleRevealPopup();
                         } else { // í˜¸ìŠ¤íŠ¸ëŠ” ë°”ë¡œ ê²Œì„ í™”ë©´ìœ¼ë¡œ
                             showScreen('game-screen');
                             updateGameUI(currentRoomData);
                         }
                    } else {
                        // ì¼ë°˜ì ì¸ UI ì—…ë°ì´íŠ¸
                        if (currentRoomData.status === 'waiting') {
                            showScreen('lobby-screen');
                            updateLobbyUI(currentRoomData);
                        } else {
                            updateGameUI(currentRoomData);
                        }
                    }

                    // --- ì¹´ì˜¤ìŠ¤ ëª¨ë“œ: ì •ë³´ ì—´ëŒ ì¹´ë“œ ê²°ê³¼ í‘œì‹œ ---
                    if (currentRoomData.gameMode === 'chaos' && oldRoomData && amIPlayer) {
                        const myCardActionResult = currentRoomData.cardActionResults?.[localPlayer.id];
                        // ê²°ê³¼ê°€ ìƒˆë¡œ ìƒê²¼ì„ ë•Œë§Œ íŒì—…ì„ ë„ì›ë‹ˆë‹¤.
                        if(myCardActionResult && JSON.stringify(myCardActionResult) !== JSON.stringify(oldRoomData.cardActionResults?.[localPlayer.id])) {
                             if(myCardActionResult.cardId === 'info_heisenberg') {
                                showCardUseEffect('í•˜ì´ì  ë² ë¥´í¬ ê´€ì¸¡ê¸°', 'ë¶ˆí™•ì •ì„± ì›ë¦¬ ì ìš© ì¤‘...');
                                setTimeout(() => {
                                    const target = currentRoomData.players[myCardActionResult.targetId];
                                    const chipsHtml = target.quantumState.map(chip => 
                                        `<div class="w-8 h-8 rounded ${chip === 'AEON' ? 'bg-red-500 neon-red-sm' : 'bg-blue-500 neon-blue-sm'}"></div>`
                                    ).join('');
                                    showCustomAlertWithHTML(`[ê´€ì¸¡ ê²°ê³¼]<br>${target.nickname}ë‹˜ì˜ ìƒíƒœíŒì…ë‹ˆë‹¤:<br><div class="flex justify-center gap-2 mt-4">${chipsHtml}</div>`);
                                }, 2500);
                             } else if (myCardActionResult.cardId === 'info_trace' && myCardActionResult.details) {
                                 showCustomAlertWithHTML(`[ì•”í˜¸ í•´ë…ê¸° ê²°ê³¼]<br>${myCardActionResult.details}`);
                             }
                        }
                    }

                } else {
                    resetLocalState();
                    showCustomAlert('í˜¸ìŠ¤íŠ¸ê°€ ë°©ì„ ë– ë‚˜ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
                    showScreen('main-menu-screen');
                }
            });
        }
        
        function updateLobbyUI(room) {
            const { host, players, minPlayers, maxPlayers, totalRounds, gameMode } = room;
            if (!players) return;
            const playerList = Object.values(players).sort((a, b) => a.number - b.number);
            const playerCount = playerList.length;
            
            document.getElementById('lobby-player-count').innerText = `í”Œë ˆì´ì–´: ${playerCount}/${minPlayers}/${maxPlayers}`;
            document.getElementById('lobby-room-id').innerText = currentRoomId;
            document.getElementById('host-info').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-crown text-cyan-300"><path d="M12 6.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"/><path d="M12 12.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"/><path d="M15.5 8.75a4.5 4.5 0 1 0 0-6.5 4.5 4.5 0 0 0 0 6.5Z"/><path d="M12.5 12.5a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0Z"/><path d="M12 15.583c-2.333.667-3.5 2.5-3.5 4.417V22h7v-2c0-1.917-1.167-3.75-3.5-4.417Z"/><path d="m18.5 14-1-1-1 1"/><path d="m18.5 18 1-1 1 1"/></svg><span class="font-bold">${host.nickname}</span>`;

            const roundInfoEl = document.getElementById('round-info');
            roundInfoEl.innerHTML = `<span class="font-bold">ì´ ë¼ìš´ë“œ:</span> <span class="text-yellow-400">${totalRounds || 4}</span>`;

            const playerSlotsEl = document.getElementById('player-slots');
            playerSlotsEl.innerHTML = '';
            
            const entangledPairs = room.entangledPairs || [];
            const entangledPlayerIds = entangledPairs.flat();

            playerList.forEach(p => {
                    const isEntangled = entangledPlayerIds.includes(p.id);
                    playerSlotsEl.innerHTML += `
                        <div class="bg-black/20 p-4 rounded-lg shadow-inner-dark">
                             <div class="flex items-center justify-between">
                                 <div class="flex items-center space-x-3">
                                     <div class="bg-orange-500 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center text-lg shadow-lg">${p.number}</div>
                                     <span class="text-white text-lg font-bold">${p.nickname}</span>
                                     ${isEntangled ? '<span title="ì–‘ì ì–½í˜ ìƒíƒœ">ğŸ”—</span>' : ''}
                                 </div>
                                 <span class="${p.isReady ? 'text-cyan-400' : 'text-gray-400'} font-bold">${p.isReady ? 'ì¤€ë¹„ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘'}</span>
                             </div>
                        </div>`;
            });
            
            const emptySlotsCount = maxPlayers - playerCount;
             for (let i = 0; i < emptySlotsCount; i++) {
                 if (isDevMode && localPlayer.isHost) {
                      playerSlotsEl.innerHTML += `<button onclick="addBotPlayer()" class="bg-green-800/20 p-4 rounded-lg flex items-center justify-center border-2 border-dashed border-green-600/50 hover:bg-green-700/30 transition-colors"><span class="text-green-400">ë´‡ ì¶”ê°€</span></button>`;
                 } else {
                      playerSlotsEl.innerHTML += `<div class="bg-black/20 p-4 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-600/50"><span class="text-gray-500">ë¹ˆ ìŠ¬ë¡¯</span></div>`;
                 }
            }

            const roundSelectionContainer = document.getElementById('round-selection-container');
            if (localPlayer.isHost) {
                roundSelectionContainer.classList.remove('hidden');
                [4, 5, 6].forEach(round => {
                    const btn = document.getElementById(`round-btn-${round}`);
                    if (btn) {
                        const isSelected = (totalRounds || 4) === round;
                        btn.classList.toggle('bg-cyan-600', isSelected);
                        btn.classList.toggle('text-white', isSelected);
                        btn.classList.toggle('border-cyan-300', isSelected);
                        btn.classList.toggle('btn-secondary', !isSelected);
                    }
                });
            } else {
                roundSelectionContainer.classList.add('hidden');
            }

            document.getElementById('ready-btn').classList.toggle('hidden', localPlayer.isHost);
            document.getElementById('start-game-btn').classList.toggle('hidden', !localPlayer.isHost);

            if(localPlayer.isHost) {
                const readyPlayerCount = playerList.filter(p => p.isReady).length;
                const canStart = isDevMode ? (playerCount >= minPlayers) : (playerCount >= minPlayers && readyPlayerCount === playerCount -1);
                const startGameBtn = document.getElementById('start-game-btn');
                startGameBtn.disabled = !canStart;
                startGameBtn.classList.toggle('neon-cyan', canStart);
                startGameBtn.classList.toggle('animate-pulse-slow', canStart);
                startGameBtn.classList.toggle('opacity-50', !canStart);
                startGameBtn.classList.toggle('cursor-not-allowed', !canStart);
            } else {
                const me = players[localPlayer.id];
                const readyBtn = document.getElementById('ready-btn');
                if (me?.isReady) {
                    readyBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
                    readyBtn.classList.add('bg-orange-600', 'hover:bg-orange-500');
                    readyBtn.innerText = "ì¤€ë¹„ì™„ë£Œ";
                } else {
                    readyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
                    readyBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
                    readyBtn.innerText = "ì¤€ë¹„";
                }
            }
        }
        
        async function toggleReady() {
            playSound('click');
            if (!currentRoomId || localPlayer.isHost) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            const playerRef = `players.${localPlayer.id}.isReady`;
            const docSnap = await getDoc(roomRef);
            if (docSnap.exists()) {
                const currentStatus = docSnap.data().players[localPlayer.id].isReady;
                await updateDoc(roomRef, { [playerRef]: !currentStatus });
            }
        }

        async function leaveRoom(isUnload) {
            hideConfirmLeavePopup();
            if (!currentRoomId) return;

            const isHost = localPlayer.isHost;
            const localIdBeforeLeave = currentRoomId;

            if (roomUnsubscribe) {
                roomUnsubscribe();
                roomUnsubscribe = null;
            }
            
            try {
                const roomRef = doc(db, 'rooms', localIdBeforeLeave);
                if (isHost) {
                    await deleteDoc(roomRef);
                } else {
                    // Non-host leaving
                    const roomDoc = await getDoc(roomRef);
                    if (roomDoc.exists()){
                        await updateDoc(roomRef, { [`players.${auth.currentUser.uid}`]: deleteField() });
                    }
                }
            } catch (error) { 
                console.error("Error during leave room operation:", error);
            } finally {
                resetLocalState();
                if (!isUnload) {
                  showScreen('main-menu-screen');
                }
            }
        }

        async function startGame() {
            playSound('click');
            if (!currentRoomId || !localPlayer.isHost) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) throw new Error("Room does not exist.");
                    const room = roomDoc.data();
                    let players = room.players;
                    
                    const playerIds = Object.keys(players);
                    const playerCount = playerIds.length;
                    const updatedPlayers = players;

                    // --- ì¹´ì˜¤ìŠ¤ ëª¨ë“œ: ì¹´ë“œ ë¶„ë°° ---
                    if (room.gameMode === 'chaos') {
                        const fullDeck = Object.keys(abilityCardDeck);
                        const shuffledDeck = fullDeck.sort(() => 0.5 - Math.random());
                        
                        playerIds.forEach((id, index) => {
                            updatedPlayers[id].abilityCard = shuffledDeck[index % shuffledDeck.length]; // ë±ì´ ë¶€ì¡±í•  ê²½ìš° ìˆœí™˜
                            updatedPlayers[id].hasUsedCard = false;
                        });
                    }

                    const aeonCount = Math.max(1, Math.floor(playerCount / 3));
                    const devCount = Math.max(1, Math.floor(playerCount / 3));
                    const citizenCount = playerCount - aeonCount - devCount;

                    const shuffledPlayerIds = playerIds.sort(() => 0.5 - Math.random());
                    const aeonIds = shuffledPlayerIds.slice(0, aeonCount);
                    const devIds = shuffledPlayerIds.slice(aeonCount, aeonCount + devCount);
                    const citizenIds = shuffledPlayerIds.slice(aeonCount + devCount);

                    aeonIds.forEach(id => {
                        updatedPlayers[id].initialRole = 'AEON';
                        updatedPlayers[id].currentRole = 'AEON';
                        updatedPlayers[id].quantumState = Array(6).fill('AEON');
                    });
                    devIds.forEach(id => {
                        updatedPlayers[id].initialRole = 'DEVELOPER';
                        updatedPlayers[id].currentRole = 'DEVELOPER';
                        updatedPlayers[id].quantumState = Array(6).fill('CITIZEN');
                    });
                    
                    if (citizenCount > 0) {
                        let totalCitizenStickers = citizenCount * 6;
                        let redStickers = Math.round(totalCitizenStickers / 2);
                        let blueStickers = totalCitizenStickers - redStickers;

                        const stickerPool = [
                            ...Array(redStickers).fill('AEON'),
                            ...Array(blueStickers).fill('CITIZEN')
                        ].sort(() => 0.5 - Math.random());
                        
                        citizenIds.forEach(id => {
                            updatedPlayers[id].initialRole = 'CITIZEN';
                            updatedPlayers[id].currentRole = 'CITIZEN';
                            updatedPlayers[id].quantumState = stickerPool.splice(0, 6);
                        });
                    }

                    transaction.update(roomRef, {
                        status: 'playing',
                        players: updatedPlayers,
                        gameState: {
                            phase: 'DAY', round: 1, subPhase: 'DISCUSSION',
                            timer: 300, 
                            message: "ì²«ë²ˆì§¸ ë‚®ì…ë‹ˆë‹¤. ì¹˜ë£Œí•  ì‚¬ëŒì„ í† ë¡ í•˜ì„¸ìš”.",
                            isPlayerActing: false
                        },
                        votes: {}, 
                        nightActions: {},
                        cardActions: {}, 
                        cardActionResults: {},
                        eventLog: [{round: 1, phase: 'ë‚®', hostText: 'ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', playerText: 'ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.'}]
                    });
                });
            } catch (e) {
                console.error("Error starting game:", e);
                showCustomAlert("ê²Œì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        function updateGameUI(room) {
            const { gameState } = room;
            if (gameState.transitionMessage) {
                showPhaseTransition(gameState.transitionMessage);
                return;
            }

            document.getElementById('night-overlay').classList.toggle('active', gameState.phase === 'NIGHT');
            const currentScreen = document.querySelector('.screen:not(.hidden)')?.id;
            let targetScreen = 'game-screen';

            if (document.getElementById('result-popup').classList.contains('hidden') === false) {
                 return;
            }
            
            if(['DAY_TIEBREAKER_ANNOUNCEMENT', 'DAY_RESULT', 'NIGHT_RESULT'].includes(gameState.subPhase)) {
                showResultPopup(room);
                return;
            }

            if (gameState.phase === 'END') {
                if (['OBSERVATION', 'MEASUREMENT_READY', 'MEASUREMENT'].includes(gameState.subPhase)) {
                    targetScreen = 'observation-screen';
                } else if (gameState.subPhase === 'RESULT') {
                    targetScreen = 'end-result-screen';
                }
            }

            if (currentScreen !== targetScreen) showScreen(targetScreen);

            if (targetScreen === 'observation-screen') {
                updateObservationUI(room);
            } else if (targetScreen === 'end-result-screen') {
                updateEndResultUI(room);
            } else {
                if (localPlayer.isHost) updateHostGameView(room);
                else updatePlayerGameView(room);
            }
            handleGamePhase(room);
        }

        function updatePlayerGameView(room) {
            const { players, gameState, gameMode, totalRounds, entangledPairs } = room;
            const me = players[localPlayer.id];
            if (!me) {
                if(localPlayer.isHost) {
                    updateHostGameView(room);
                }
                return;
            };

            document.getElementById('hud-player-info').innerHTML = `<span class="font-bold text-lg sm:text-2xl">${me.number}</span> ${me.nickname}`;
            
            let subPhaseText = gameState.subPhase;
            if (gameState.subPhase === 'DISCUSSION') subPhaseText = 'í† ë¡ ';
            else if (gameState.subPhase === 'VOTE') subPhaseText = 'íˆ¬í‘œ';
            else if (gameState.subPhase === 'ACTION') subPhaseText = 'í–‰ë™';
            const phaseText = `<span class="text-sm sm:text-base">${gameState.round} / ${totalRounds || 4} ë¼ìš´ë“œ</span><br>${gameState.phase === 'DAY' ? 'ë‚®' : 'ë°¤'} / ${subPhaseText}`;
            document.getElementById('hud-phase').innerHTML = phaseText;
            
            let myRoleText = "ê³¼í•™ì";
            if (me.currentRole === 'AEON') myRoleText = "ì—ì´ì˜¨";
            if (me.currentRole === 'DEVELOPER') myRoleText = "ë°±ì‹  ê°œë°œì";
            document.getElementById('hud-role').innerHTML = `<span>${myRoleText}</span>`;
            
            updateTimer(room);

            const mainContentEl = document.getElementById('game-main-content');
            const otherPlayers = Object.values(players).filter(p => p.id !== localPlayer.id).sort((a,b)=>a.number - b.number);
            const myChipsHtml = me.quantumState.map(chip => 
                `<div class="w-full h-8 rounded ${chip === 'AEON' ? 'bg-red-500 neon-red-sm' : 'bg-blue-500 neon-blue-sm'}"></div>`
            ).join('');

            // --- ì¹´ì˜¤ìŠ¤ ëª¨ë“œ: ë‚´ ì¹´ë“œ UI ë Œë”ë§ ---
            let myCardHtml = '';
            if (gameMode === 'chaos' && me.abilityCard) {
                const card = abilityCardDeck[me.abilityCard];
                const isUsable = isCardUsableNow(card, gameState);
                const hasUsed = me.hasUsedCard;
                
                let buttonText = hasUsed ? 'ì‚¬ìš© ì™„ë£Œ' : (isUsable ? 'ì‚¬ìš©í•˜ê¸°' : 'ì‚¬ìš© ë¶ˆê°€');
                let buttonDisabled = !isUsable || hasUsed;

                if (card.name === 'ì•”í˜¸ í•´ë…ê¸°' && hasUsed) {
                    buttonText = 'ì˜ˆì•½ë¨';
                }

                myCardHtml = `
                <div class="screen-panel p-4 ${hasUsed ? 'opacity-50' : ''}">
                    <h3 class="font-bold text-lg text-yellow-300 mb-2">ë‚´ ëŠ¥ë ¥ ì¹´ë“œ</h3>
                    <div class="bg-black/20 p-3 rounded-lg">
                        <p class="font-bold text-cyan-300 text-xl font-orbitron">${card.name} ${hasUsed && card.name !== 'ì•”í˜¸ í•´ë…ê¸°' ? '(ì‚¬ìš© ì™„ë£Œ)' : ''}</p>
                        <p class="text-gray-300 mt-1">${card.description}</p>
                        <p class="text-xs text-gray-500 mt-2">ì‚¬ìš© ì‹œì : ${card.timing}</p>
                        <button 
                            onclick="handleCardClick()" 
                            class="w-full mt-3 py-2 rounded text-black font-bold transition-all 
                                ${!buttonDisabled ? 'bg-yellow-400 hover:bg-yellow-300' : 'bg-gray-600 cursor-not-allowed'}"
                            ${buttonDisabled ? 'disabled' : ''}
                        >
                            ${buttonText}
                        </button>
                    </div>
                </div>
                `;
            }

            mainContentEl.innerHTML = `
                <div id="player-board-${me.id}" class="screen-panel p-6 border-2 border-cyan-300/50">
                    <h2 class="title-text text-2xl font-bold text-center mb-4">ë‚˜ì˜ ìƒíƒœíŒ</h2>
                    <div class="grid grid-cols-6 gap-2 max-w-sm mx-auto">
                        ${myChipsHtml}
                    </div>
                </div>
                ${myCardHtml}
                <div class="screen-panel p-4">
                    <h3 class="font-bold mb-2">ë‹¤ë¥¸ í”Œë ˆì´ì–´</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    ${otherPlayers.map(p => {
                        const isEntangled = (entangledPairs || []).flat().includes(p.id);
                        return `
                        <div class="p-2 rounded ${p.isAlive ? 'bg-black/20' : 'bg-black/40 opacity-50'}">
                            <span class="font-bold">${p.number}. ${p.nickname}</span>
                            ${isEntangled ? '<span title="ì–‘ì ì–½í˜ ìƒíƒœ">ğŸ”—</span>' : ''}
                            ${p.isAlive ? '' : '<span class="text-red-500 text-sm">ì‚¬ë§</span>'}
                        </div>
                    `}).join('')}
                    </div>
                </div>
            `;
        }
        
        function updateHostGameView(room) {
            const { players, gameState, votes, nightActions, totalRounds, entangledPairs } = room;
            
            document.getElementById('hud-player-info').innerHTML = `<span class="font-bold text-lg sm:text-2xl">HOST</span> ${localPlayer.nickname}`;
            
            let subPhaseText = gameState.subPhase;
            if (gameState.subPhase === 'DISCUSSION') subPhaseText = 'í† ë¡ ';
            else if (gameState.subPhase === 'VOTE') subPhaseText = 'íˆ¬í‘œ';
            else if (gameState.subPhase === 'ACTION') subPhaseText = 'í–‰ë™';
            const phaseText = `<span class="text-sm sm:text-base">${gameState.round} / ${totalRounds || 4} ë¼ìš´ë“œ</span><br>${gameState.phase === 'DAY' ? 'ë‚®' : 'ë°¤'} / ${subPhaseText}`;
            document.getElementById('hud-phase').innerHTML = phaseText;
            document.getElementById('hud-role').innerHTML = `<span>ê´€ì „ ëª¨ë“œ</span>`;
            updateTimer(room);

            const mainContentEl = document.getElementById('game-main-content');
            mainContentEl.innerHTML = Object.values(players).sort((a,b)=>a.number - b.number).map(p => {
                const chipsHtml = p.quantumState.map(chip => 
                    `<div class="w-full h-4 rounded ${chip === 'AEON' ? 'bg-red-500 neon-red-sm' : 'bg-blue-500 neon-blue-sm'}"></div>`
                ).join('');
                
                let actionStatus = '';
                if (gameState.subPhase === 'VOTE') {
                    actionStatus = votes[p.id] ? `<span class="text-green-400" title="íˆ¬í‘œ ì™„ë£Œ">ğŸ—³ï¸</span>` : `<span class="text-gray-400">íˆ¬í‘œì¤‘</span>`;
                } else if (gameState.subPhase === 'ACTION') {
                    const isActionPlayer = p.currentRole !== 'CITIZEN';
                    if (isActionPlayer) {
                         actionStatus = nightActions[p.id] ? `<span class="text-green-400">í–‰ë™ì™„ë£Œ</span>` : `<span class="text-gray-400">ëŒ€ê¸°ì¤‘</span>`;
                    }
                }
                
                let botControls = '';
                if (isDevMode && p.id.startsWith('bot') && p.isAlive) {
                    if (gameState.subPhase === 'VOTE' && !votes[p.id]) {
                        botControls += `<button class="text-xs bg-blue-600 px-1 rounded ml-1" onclick="hostControlBot('${p.id}', 'VOTE')">íˆ¬í‘œ</button>`;
                    } else if (gameState.subPhase === 'ACTION' && !nightActions[p.id] && p.currentRole !== 'CITIZEN') {
                        botControls += `<button class="text-xs bg-purple-600 px-1 rounded ml-1" onclick="hostControlBot('${p.id}', 'ACTION')">í–‰ë™</button>`;
                    }
                    const card = p.abilityCard ? abilityCardDeck[p.abilityCard] : null;
                    if (card && !p.hasUsedCard && isCardUsableNow(card, gameState)) {
                        botControls += `<button class="text-xs bg-yellow-600 px-1 rounded ml-1" onclick="hostControlBotCard('${p.id}')">ì¹´ë“œ</button>`;
                    }
                }

                // --- ì¹´ì˜¤ìŠ¤ ëª¨ë“œ: í˜¸ìŠ¤íŠ¸ ë·°ì— ì¹´ë“œ ì •ë³´ í‘œì‹œ ---
                let cardInfoHtml = '';
                if(room.gameMode === 'chaos' && p.abilityCard) {
                    const card = abilityCardDeck[p.abilityCard];
                    const cardUsed = p.hasUsedCard ? '<s>' : '';
                    const cardUsedEnd = p.hasUsedCard ? '</s>' : '';
                    cardInfoHtml = `<div class="text-xs text-yellow-400/70 truncate" title="${card.description}">${cardUsed}[${card.name}]${cardUsedEnd}</div>`;
                }

                const isEntangled = (entangledPairs || []).flat().includes(p.id);

                return `
                    <div id="player-board-${p.id}" class="p-3 rounded-lg ${p.isAlive ? 'bg-black/20' : 'bg-black/40 opacity-50'}">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-lg">${p.number}. ${p.nickname} ${isEntangled ? 'ğŸ”—' : ''} [${p.currentRole.slice(0,1)}]</span>
                            <div class="flex items-center space-x-2">
                                ${botControls}
                                ${actionStatus}
                                ${p.isAlive ? '' : '<span class="text-red-500 font-bold ml-2">ì‚¬ë§</span>'}
                            </div>
                        </div>
                        <div class="grid grid-cols-6 gap-1 mt-2">${chipsHtml}</div>
                        ${cardInfoHtml}
                    </div>
                `;
            }).join('');
            
            const hostProceedBtn = document.getElementById('host-proceed-btn');
            const hostSkipVoteBtn = document.getElementById('host-skip-vote-btn');
            const livingPlayers = Object.values(players).filter(p => p.isAlive);
            let allActed = false;
            
            if (gameState.subPhase === 'VOTE' || gameState.subPhase === 'ACTION') {
                 if (isDevMode && localPlayer.isHost) {
                    hostSkipVoteBtn.classList.remove('hidden');
                }
            } else {
                 hostSkipVoteBtn.classList.add('hidden');
            }
            
            if (gameState.subPhase === 'VOTE') {
                allActed = livingPlayers.length > 0 && livingPlayers.every(p => votes[p.id]);
            } else if (gameState.subPhase === 'ACTION') {
                const actingPlayers = livingPlayers.filter(p => p.currentRole !== 'CITIZEN');
                allActed = actingPlayers.length === 0 || actingPlayers.every(p => nightActions[p.id]);
            }

            if (allActed) {
                hostProceedBtn.classList.remove('hidden');
                 hostSkipVoteBtn.classList.add('hidden'); // ëª¨ë‘ í–‰ë™í–ˆìœ¼ë©´ ìŠ¤í‚µ ë²„íŠ¼ ìˆ¨ê¹€
            } else {
                hostProceedBtn.classList.add('hidden');
            }
        }
        
        function updateTimer(room) {
            const { gameState } = room;
            const timerEl = document.getElementById('timer');
            const hostSkipBtn = document.getElementById('host-skip-timer-btn');

            if (localPlayer.isHost && (gameState.subPhase === 'DISCUSSION' || gameState.subPhase === 'OBSERVATION')) {
                hostSkipBtn.classList.remove('hidden');
                hostSkipBtn.disabled = gameState.isPlayerActing;
                hostSkipBtn.classList.toggle('opacity-50', gameState.isPlayerActing);
                hostSkipBtn.classList.toggle('cursor-not-allowed', gameState.isPlayerActing);
            } else {
                hostSkipBtn.classList.add('hidden');
            }
            
            if (gameState.subPhase === 'DISCUSSION') {
                timerEl.classList.remove('hidden');
                if(gameTimerInterval) clearInterval(gameTimerInterval);
                let timer = gameState.timer;
                const totalTime = gameState.timer;
                const timerBar = document.getElementById('timer-bar-inner');
                const timerText = document.getElementById('timer-text');
                
                const updateDisplay = () => {
                    const percentage = Math.max(0, (timer / totalTime) * 100);
                    timerBar.style.width = `${percentage}%`;
                    timerText.innerText = Math.max(0, timer);
                    if (timer <= 10) {
                        timerBar.classList.remove('bg-cyan-400');
                        timerBar.classList.add('bg-red-500');
                    } else {
                        timerBar.classList.remove('bg-red-500');
                        timerBar.classList.add('bg-cyan-400');
                    }
                };
                
                updateDisplay();

                gameTimerInterval = setInterval(() => {
                    timer--;
                    updateDisplay();
                    if (timer === 10) playSound('timerTick');

                    if (timer < 0) {
                        clearInterval(gameTimerInterval);
                        if (localPlayer.isHost) hostProceedPhase();
                    }
                }, 1000);
            } else {
                timerEl.classList.add('hidden');
                if(gameTimerInterval) clearInterval(gameTimerInterval);
            }
        }

        async function hostProceedPhase() {
            if (!currentRoomId || !localPlayer.isHost) return;
            
            if (currentRoomData.gameState.isPlayerActing) {
                showCustomAlert('í˜„ì¬ ë‹¤ë¥¸ í”Œë ˆì´ì–´ê°€ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                return;
            }

            const roomRef = doc(db, "rooms", currentRoomId);
            const roomDocForPhase = await getDoc(roomRef);
            if (!roomDocForPhase.exists()) return;
            const currentSubPhase = roomDocForPhase.data().gameState.subPhase;

            let transitionMessage = null;
            if (currentSubPhase === 'DAY_RESULT') {
                transitionMessage = "ENTERING NIGHT PROTOCOL...";
            } else if (currentSubPhase === 'NIGHT_RESULT') {
                transitionMessage = "SYSTEM REBOOTING FOR DAY CYCLE...";
            }

            if(transitionMessage) {
                await updateDoc(roomRef, { 'gameState.transitionMessage': transitionMessage });
                setTimeout(() => {
                    runPhaseLogic(roomRef);
                }, 3000); // 3ì´ˆ í›„ ì‹¤ì œ ë¡œì§ ì‹¤í–‰
            } else {
                runPhaseLogic(roomRef);
            }
        }

        async function runPhaseLogic(roomRef) {
             playSound('phaseChange');
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;

                    let room = roomDoc.data();
                    let { gameState, players, votes, nightActions, eventLog, cardActions } = room;
                    let newGameState = { ...gameState };
                    delete newGameState.transitionMessage;
                    let newPlayers = JSON.parse(JSON.stringify(players));
                    let newLogEntries = [];
                    let newCardActionResults = {...room.cardActionResults};

                    if (gameState.phase === 'DAY' && gameState.subPhase === 'DISCUSSION') {
                        if (room.gameMode === 'chaos' && cardActions && Object.keys(cardActions).length > 0) {
                            const effectResults = applyCardEffects(cardActions, newPlayers, newGameState, newLogEntries);
                            newPlayers = effectResults.players;
                            newCardActionResults = {...newCardActionResults, ...effectResults.cardActionResults};
                            newGameState = {...newGameState, ...effectResults.gameState};
                        }
                    }

                    const checkAndApplyRoleChange = (player) => {
                        if (!player.isAlive) return;
                        const oldRole = player.currentRole;
                        const isAllAeon = player.quantumState.every(s => s === 'AEON');
                        const isAllCitizen = player.quantumState.every(s => s === 'CITIZEN');

                        if (isAllAeon) player.currentRole = 'AEON';
                        else if (isAllCitizen) player.currentRole = 'DEVELOPER';
                        else player.currentRole = 'CITIZEN';

                        if (oldRole !== player.currentRole) {
                           newLogEntries.push({
                                round: gameState.round, phase: gameState.phase === 'DAY' ? 'ë‚®' : 'ë°¤',
                                hostText: `${player.nickname}ì˜ ì—­í• ì´ ${oldRole}ì—ì„œ ${player.currentRole}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                                playerText: `${player.nickname}ì˜ ì—­í• ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
                            });
                        }
                    };

                    if (gameState.phase === 'DAY') {
                        if (gameState.subPhase === 'DISCUSSION') {
                            newGameState.subPhase = 'VOTE';
                            newGameState.message = "ì¹˜ë£Œì œë¥¼ íˆ¬ì—¬í•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”.";
                            delete newGameState.revoteCandidates;
                        } else if (gameState.subPhase === 'VOTE') {
                            const voteCounts = {};
                            Object.values(votes).forEach(votedId => { if(votedId) voteCounts[votedId] = (voteCounts[votedId] || 0) + 1; });
                            let maxVotes = 0;
                            Object.values(voteCounts).forEach(count => { if (count > maxVotes) maxVotes = count; });
                            const maxVotePlayerIds = [];
                            if (maxVotes > 0) {
                                for (const playerId in voteCounts) { if (voteCounts[playerId] === maxVotes) maxVotePlayerIds.push(playerId); }
                            }

                            if (maxVotePlayerIds.length === 1) {
                                const healedId = maxVotePlayerIds[0];
                                const healedPlayer = newPlayers[healedId];
                                const targetState = healedPlayer.quantumState;
                                const aeonIndex = targetState.indexOf('AEON');
                                if (aeonIndex > -1) {
                                    targetState[aeonIndex] = 'CITIZEN';
                                    newLogEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${healedPlayer.nickname}ë‹˜ì´ ì¹˜ë£Œì œë¥¼ ë°›ì•„ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, playerText: `${healedPlayer.nickname}ë‹˜ì´ ì¹˜ë£Œì œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`});
                                }
                                checkAndApplyRoleChange(healedPlayer);
                                newGameState.subPhase = 'DAY_RESULT';
                                newGameState.lastVoteResult = { winner: healedId };
                            } else if (maxVotePlayerIds.length > 1) {
                                newGameState.subPhase = 'DAY_TIEBREAKER_ANNOUNCEMENT';
                                newGameState.revoteCandidates = maxVotePlayerIds;
                            } else {
                                newGameState.subPhase = 'DAY_RESULT';
                                newGameState.lastVoteResult = { winner: null };
                                newLogEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `ì•„ë¬´ë„ ì¹˜ë£Œë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`, playerText: `ì•„ë¬´ë„ ì¹˜ë£Œë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`});
                            }
                        } else if (gameState.subPhase === 'DAY_TIEBREAKER_ANNOUNCEMENT') {
                            newGameState.subPhase = 'VOTE';
                            newGameState.message = `ìµœë‹¤ ë“í‘œìê°€ ${gameState.revoteCandidates.length}ëª…ì…ë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ íˆ¬í‘œí•´ì£¼ì„¸ìš”.`;
                        } else if (gameState.subPhase === 'DAY_RESULT') {
                            
                            // *** NEW LOGIC START: ìˆ™ì£¼ í”„ë¡œí† ì½œ ë°œë™ ì²´í¬ ***
                            const currentAeonCount = Object.values(newPlayers).filter(p => p.isAlive && p.currentRole === 'AEON').length;
                            if (currentAeonCount === 0) {
                                const hostProtocolPlayer = Object.values(newPlayers).find(p => p.isAlive && p.abilityCard === 'state_host' && !p.hasUsedCard);
                                if (hostProtocolPlayer) {
                                    newPlayers[hostProtocolPlayer.id].quantumState = Array(6).fill('AEON');
                                    checkAndApplyRoleChange(newPlayers[hostProtocolPlayer.id]);
                                    newPlayers[hostProtocolPlayer.id].hasUsedCard = true; // ìˆ™ì£¼ í”„ë¡œí† ì½œì€ 1íšŒì„±
                                    newLogEntries.push({ round: gameState.round, phase: 'ë‚®', hostText: `ì—ì´ì˜¨ì´ ì „ë©¸í•˜ì—¬ ${hostProtocolPlayer.nickname}ë‹˜ì´ [ìˆ™ì£¼ í”„ë¡œí† ì½œ]ì— ë”°ë¼ ìƒˆë¡œìš´ ì—ì´ì˜¨ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`, playerText: `ì—ì´ì˜¨ì´ ì „ë©¸í•˜ì [ìˆ™ì£¼ í”„ë¡œí† ì½œ]ì´ ë°œë™ë˜ì—ˆìŠµë‹ˆë‹¤.` });
                                }
                            }
                            // *** NEW LOGIC END ***

                            newGameState.phase = 'NIGHT';
                            newGameState.subPhase = 'DISCUSSION';
                            newGameState.timer = 300;
                            newGameState.message = "ë°¤ì…ë‹ˆë‹¤. ê°ì—¼ ë° ë³´í˜¸ ëŒ€ìƒì„ í† ë¡ í•˜ì„¸ìš”.";
                            delete newGameState.revoteCandidates;
                            delete newGameState.lastVoteResult;
                        }
                    } else if (gameState.phase === 'NIGHT') {
                        if (gameState.subPhase === 'DISCUSSION') {
                             newGameState.subPhase = 'ACTION';
                             newGameState.message = "ëŠ¥ë ¥ì„ ì‚¬ìš©í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.";
                        } else if (gameState.subPhase === 'ACTION') {
                            let results = { successfulInfections: [], successfulProtections: [], failedInfections: [] };
                            const protections = {};
                            let isFirewallActive = gameState.isFirewallActive;

                            Object.values(newPlayers).filter(p=>p.isAlive && p.currentRole === 'DEVELOPER').forEach(p => {
                                const targetIds = nightActions[p.id]?.targetIds || [];
                                targetIds.forEach(targetId => {
                                     if(targetId) protections[targetId] = p.id;
                                });
                            });

                            Object.values(newPlayers).filter(p=>p.isAlive && p.currentRole === 'AEON').forEach(p => {
                                const targetIds = nightActions[p.id]?.targetIds || [];
                                
                                // *** NEW LOGIC START: ì¤‘ë³µ ê°ì—¼ ì²˜ë¦¬ ë¡œì§ ***
                                const targetsToInfect = {};
                                targetIds.forEach(id => {
                                    targetsToInfect[id] = (targetsToInfect[id] || 0) + 1;
                                });

                                for (const targetId in targetsToInfect) {
                                    if(targetId) {
                                        const infectionCount = targetsToInfect[targetId];
                                        for (let i = 0; i < infectionCount; i++) {
                                            if (protections[targetId] || isFirewallActive) {
                                                if (!results.failedInfections.find(f => f.targetId === targetId)) { // ì¤‘ë³µ ë¡œê·¸ ë°©ì§€
                                                    results.failedInfections.push({ attackerId: p.id, targetId: targetId, protectorId: protections[targetId] });
                                                    if(protections[targetId] && !results.successfulProtections.find(prot => prot.targetId === targetId)) {
                                                        results.successfulProtections.push({ protectorId: protections[targetId], targetId: targetId });
                                                    }
                                                }
                                            } else {
                                                results.successfulInfections.push({ attackerId: p.id, targetId: targetId }); // ë¡œê·¸ëŠ” ì¤‘ë³µ ê¸°ë¡ë  ìˆ˜ ìˆìŒ
                                                const targetPlayer = newPlayers[targetId];
                                                const targetState = targetPlayer.quantumState;
                                                const citizenIndex = targetState.indexOf('CITIZEN');
                                                if (citizenIndex > -1) {
                                                    targetState[citizenIndex] = 'AEON';
                                                }
                                            }
                                        }
                                    }
                                }
                                // ê°ì—¼ ì²˜ë¦¬ í›„ ì—­í•  ë³€ê²½ ì²´í¬
                                Object.keys(targetsToInfect).forEach(targetId => {
                                    if(newPlayers[targetId]) checkAndApplyRoleChange(newPlayers[targetId]);
                                });
                                // *** NEW LOGIC END ***
                            });
                            
                            const traceUsers = Object.keys(players).filter(pid => players[pid].abilityCard === 'info_trace' && cardActions[pid]);
                            if (traceUsers.length > 0) {
                                let report = "ë°¤ ì‚¬ì´ í™œë™ ê²°ê³¼:<br>";
                                let activity = false;
                                if (results.successfulProtections.length > 0) { activity = true; report += results.successfulProtections.map(p => `ğŸ›¡ï¸ ${players[p.protectorId].nickname} ë‹˜ì´ ${players[p.targetId].nickname} ë‹˜ì„ ë³´í˜¸í–ˆìŠµë‹ˆë‹¤.`).join('<br>'); }
                                if (results.failedInfections.length > 0) { activity = true; report += '<br>' + results.failedInfections.map(f => `ğŸ’¥ ${players[f.attackerId].nickname} ë‹˜ì˜ ê°ì—¼ ì‹œë„ê°€ ${players[f.protectorId] ? players[f.protectorId].nickname + ' ë‹˜ì˜ ë³´í˜¸ë¡œ' : 'ë°©í™”ë²½ì— ì˜í•´'} ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (ëŒ€ìƒ: ${players[f.targetId].nickname}).`).join('<br>');}
                                if (results.successfulInfections.length > 0) { activity = true; report += '<br>' + results.successfulInfections.map(i => `ğŸ’€ ${players[i.attackerId].nickname} ë‹˜ì´ ${players[i.targetId].nickname} ë‹˜ì„ ê°ì—¼ì‹œì¼°ìŠµë‹ˆë‹¤.`).join('<br>');}
                                if(isFirewallActive && results.failedInfections.length > 0 && !results.successfulProtections.length > 0) { activity = true; report += '<br>ğŸ›¡ï¸ ë°©í™”ë²½ì— ì˜í•´ ëª¨ë“  ê°ì—¼ì´ ë§‰í˜”ìŠµë‹ˆë‹¤.'; }
                                if (!activity) { report += "ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; }
                                traceUsers.forEach(userId => {
                                    newCardActionResults[userId] = { cardId: 'info_trace', details: report };
                                });
                            }
                            
                            newGameState.subPhase = 'NIGHT_RESULT';
                            newGameState.lastNightResults = results;
                            
                            if (results.successfulProtections.length > 0) newLogEntries.push({round: gameState.round, phase: 'ë°¤', hostText: `${results.successfulProtections.map(p => players[p.protectorId].nickname).join(', ')}ê°€ ë°±ì‹ ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, playerText: `ëˆ„êµ°ê°€ ë°±ì‹ ìœ¼ë¡œ ê°ì—¼ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.`});
                            if (results.successfulInfections.length > 0) newLogEntries.push({round: gameState.round, phase: 'ë°¤', hostText: `${results.successfulInfections.map(i => players[i.targetId].nickname).join(', ')}ì´(ê°€) ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤.`, playerText: `ë°¤ ì‚¬ì´ ëˆ„êµ°ê°€ ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤.`});
                            if(isFirewallActive) newLogEntries.push({round: gameState.round, phase: 'ë°¤', hostText: `ë°©í™”ë²½ì´ ê°ì—¼ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.`, playerText: `ë°©í™”ë²½ì´ ê°ì—¼ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.`});
                            if (results.successfulInfections.length === 0 && results.successfulProtections.length === 0 && !isFirewallActive) newLogEntries.push({round: gameState.round, phase: 'ë°¤', hostText: `ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`, playerText: `ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`});
                            
                        } else if (gameState.subPhase === 'NIGHT_RESULT') {

                            // ìˆ™ì£¼ í”„ë¡œí† ì½œ ë¡œì§ì„ ë‚®ìœ¼ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì‚­ì œ
                            
                            const finalAeonCount = Object.values(newPlayers).filter(p => p.isAlive && p.currentRole === 'AEON').length;
                            newLogEntries.push({ round: gameState.round, phase: 'ë°¤', hostText: `í˜„ì¬ ì—ì´ì˜¨ ìˆ˜: ${finalAeonCount}ëª…`, playerText: `í˜„ì¬ ì—ì´ì˜¨ ìˆ˜: ${finalAeonCount}ëª…`});

                            newGameState.round += 1;
                            if (newGameState.round > room.totalRounds) {
                                newGameState.phase = 'END';
                                newGameState.subPhase = 'OBSERVATION';
                                newGameState.timer = 30; 
                                newGameState.message = "ë¼ìš´ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìƒíƒœíŒì„ í™•ì¸í•˜ì„¸ìš”.";
                            } else {
                                newGameState.phase = 'DAY';
                                newGameState.subPhase = 'DISCUSSION';
                                newGameState.timer = 300;
                                newGameState.message = `${newGameState.round}ë²ˆì§¸ ë‚®ì…ë‹ˆë‹¤. ì¹˜ë£Œí•  ì‚¬ëŒì„ í† ë¡ í•˜ì„¸ìš”.`;
                            }
                            delete newGameState.isFirewallActive; // ë°¤ì´ ëë‚˜ë©´ ë°©í™”ë²½ íš¨ê³¼ ì œê±°
                        }
                    }
                    
                    transaction.update(roomRef, { 
                        gameState: newGameState, 
                        players: newPlayers, 
                        votes: {}, 
                        nightActions: {},
                        cardActions: {},
                        cardActionResults: newCardActionResults,
                        eventLog: [...(eventLog || []), ...newLogEntries]
                    });
                });
            } catch(e) {
                console.error("Error proceeding phase: ", e);
                showCustomAlert("ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function handleGamePhase(room) {
            const { gameState, players, votes, nightActions } = room;
            hideActionPopup();
            if (localPlayer.isHost) return; 

            const me = players[localPlayer.id];
            if (!me) return;

            if (!me.isAlive) {
                showActionPopup("ë‹¹ì‹ ì€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.", "ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì„ ê´€ì „í•˜ì„¸ìš”.", true);
                return;
            }

            const subPhase = gameState.subPhase;
            if (gameState.phase === 'DAY') {
                if (subPhase === 'DISCUSSION') {
                    showActionPopup("ë‚® í† ë¡ ", gameState.message, true);
                } else if (subPhase === 'VOTE') {
                    if (votes[localPlayer.id]) {
                        showActionPopup("íˆ¬í‘œ ì™„ë£Œ", "ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ íˆ¬í‘œë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...", false);
                    } else {
                        let voteTargets;
                        if (gameState.revoteCandidates && gameState.revoteCandidates.length > 0) {
                            voteTargets = Object.values(players).filter(p => p.isAlive && gameState.revoteCandidates.includes(p.id));
                        } else {
                            voteTargets = Object.values(players).filter(p => p.isAlive);
                        }
                        showVotePopup("ë‚® íˆ¬í‘œ", gameState.message, voteTargets, 'submitVote');
                    }
                }
            } else if (gameState.phase === 'NIGHT') {
                 if (subPhase === 'DISCUSSION') {
                    showActionPopup("ë°¤ í† ë¡ ", gameState.message, true);
                 } else if (subPhase === 'ACTION') {
                    if (nightActions[localPlayer.id]) {
                         showActionPopup("ë°¤ í–‰ë™ ì™„ë£Œ", "ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì„ íƒì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...", false);
                    } else if (me.currentRole === 'CITIZEN') {
                        submitNightAction([]);
                    } else {
                        // *** BUG FIX START: ê°œë°œì/ì—ì´ì˜¨ ëŠ¥ë ¥ ê°•í™” ë¡œì§ ìˆ˜ì • ***
                        let maxTargets = 1;
                        let title, desc, actionTargets;
                        
                        const isSuperPowered = (me.abilityCard === 'power_latent') || (me.abilityCard === 'state_host' && me.hasUsedCard);

                        if (me.currentRole === 'DEVELOPER') {
                            title = "ë³´í˜¸ í™œë™";
                            actionTargets = Object.values(players).filter(p => p.isAlive); // ìì‹  í¬í•¨
                            if (isSuperPowered) {
                                maxTargets = 2;
                                desc = "[ì ì¬ëœ í˜] ë³´í˜¸í•  í”Œë ˆì´ì–´ 2ëª…ì„ ì„ íƒí•˜ì„¸ìš”. (ìì‹  í¬í•¨)";
                            } else {
                                desc = "ê°ì—¼ìœ¼ë¡œë¶€í„° ë³´í˜¸í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ìì‹  í¬í•¨)";
                            }
                        } else { // AEON
                            title = "ê°ì—¼ í™œë™";
                            actionTargets = Object.values(players).filter(p => p.isAlive && p.id !== me.id);
                            
                            if (isSuperPowered) {
                                maxTargets = 2;
                                title = me.abilityCard === 'state_host' ? "[ìˆ™ì£¼ í”„ë¡œí† ì½œ] ê°ì—¼ í™œë™" : "[ì ì¬ëœ í˜] ê°ì—¼ í™œë™";
                                desc = "ê°ì—¼ì‹œí‚¬ í”Œë ˆì´ì–´ 2ëª…ì„ ì„ íƒí•˜ì„¸ìš”. (í•œ ëª…ì—ê²Œ ì¤‘ë³µ ê°€ëŠ¥)";
                                actionTargets = Object.values(players).filter(p => p.isAlive); // ì¤‘ë³µ ê°ì—¼ì„ ìœ„í•´ ìì‹ ë„ ì ì‹œ í¬í•¨ (ë¡œì§ìƒ ë¬¸ì œëŠ” ì—†ìŒ)
                            } else {
                                desc = "ê°ì—¼ì‹œí‚¬ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
                            }
                        }
                        showVotePopup(title, desc, actionTargets, 'submitNightAction', maxTargets);
                        // *** BUG FIX END ***
                    }
                }
            } else if (gameState.phase === 'END' && ['OBSERVATION', 'MEASUREMENT', 'MEASUREMENT_READY'].includes(subPhase)) {
                showActionPopup("ìµœì¢… ë‹¨ê³„", "ëŠ¥ë ¥ ì¹´ë“œ ì‚¬ìš© ë° ìš´ëª… ì¸¡ì •ì´ ì§„í–‰ë©ë‹ˆë‹¤.", true);
            }
        }

        function showResultPopup(room) {
            const { gameState, players } = room;
            const popup = document.getElementById('result-popup');
            if (!popup.classList.contains('hidden')) return; 

            const iconEl = document.getElementById('result-icon');
            const textEl = document.getElementById('result-text');
            const detailsEl = document.getElementById('result-details');
            detailsEl.innerHTML = '';
            let timeoutDuration = 3000;

            if(gameState.subPhase === 'DAY_TIEBREAKER_ANNOUNCEMENT') {
                iconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users text-yellow-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`;
                textEl.innerText = "ë™ì ìê°€ ë°œìƒí•˜ì—¬ ì¬íˆ¬í‘œí•©ë‹ˆë‹¤.";
            } else if(gameState.subPhase === 'DAY_RESULT') {
                const { winner } = gameState.lastVoteResult;
                let resultMessage = "ì¹˜ë£Œì œê°€ íˆ¬ì—¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                if(winner) {
                    const healedPlayer = players[winner];
                    if(healedPlayer) resultMessage = `ì¹˜ë£Œì œ íˆ¬ì—¬ì: ${healedPlayer.nickname}`;
                } else if (room.votes) {
                    const voteCounts = Object.values(room.votes).reduce((acc, curr) => (acc[curr] = (acc[curr] || 0) + 1, acc), {});
                    const maxVotes = Math.max(0, ...Object.values(voteCounts));
                    if (Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes).length > 1) {
                        resultMessage = "ì¹˜ë£Œì œ íˆ¬ì—¬ê°€ ë™ì ìœ¼ë¡œ ë¬´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    }
                }
                iconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-syringe text-cyan-400 animate-pulse"><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15 1"/><path d="m9 11 4 4"/><path d="m5 15 4 4"/><path d="m16 4 4 4"/></svg>`;
                textEl.innerText = resultMessage;
            } else if (gameState.subPhase === 'NIGHT_RESULT') {
                 iconEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon-star text-indigo-400 animate-pulse"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/><path d="M19 3v4"/><path d="M21 5h-4"/></svg>`;
                 textEl.innerText = "ë°¤ì´ ì§€ë‚˜ê³  ì•„ì¹¨ì´ ë°ì•˜ìŠµë‹ˆë‹¤.";
                 timeoutDuration = 5000;
                 
                 const { successfulInfections, successfulProtections, failedInfections } = gameState.lastNightResults;
                 let detailsHTML = '';
                 
                 if (localPlayer.isHost) {
                      successfulProtections.forEach(p => {
                           detailsHTML += `<div class="flex items-center justify-center text-green-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check mr-2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg> ${players[p.protectorId].nickname} â†’ ${players[p.targetId].nickname} ë³´í˜¸ ì„±ê³µ.</div>`;
                      });
                      failedInfections.forEach(f => {
                           detailsHTML += `<div class="flex items-center justify-center text-yellow-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-off mr-2"><path d="M19.69 14a6.9 6.9 0 0 0-9.38-9.38"/><path d="M4 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="2" x2="22" y1="2" y2="22"/></svg> ${players[f.attackerId].nickname} â†’ ${players[f.targetId].nickname} ê°ì—¼ ì‹¤íŒ¨.</div>`;
                      });
                      successfulInfections.forEach(i => {
                           detailsHTML += `<div class="flex items-center justify-center text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-virus mr-2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="m8 8 1.41-1.41"/><path d="M14.59 9.41 16 8"/><path d="m8 16 1.41 1.41"/><path d="M14.59 14.59 16 16"/><path d="M12 8v8"/><path d="m9.41 14.59 1.41-1.41"/><path d="m16 14.59-1.41-1.41"/><path d="m9.41 9.41 1.41 1.41"/></svg> ${players[i.attackerId].nickname} â†’ ${players[i.targetId].nickname} ê°ì—¼ ì„±ê³µ.</div>`;
                      });
                 } else {
                       if (successfulProtections.length > 0) detailsHTML += `<p class="text-green-400">ëˆ„êµ°ê°€ ë°±ì‹ ìœ¼ë¡œ ê°ì—¼ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.</p>`;
                       if (gameState.isFirewallActive) detailsHTML += `<p class="text-blue-400">ë°©í™”ë²½ì´ ëª¨ë“  ê°ì—¼ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤.</p>`;
                       else if (successfulInfections.length > 0) detailsHTML += `<p class="text-red-400">ë°¤ ì‚¬ì´ ëˆ„êµ°ê°€ ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
                 }

                 if (detailsHTML === '') {
                      detailsHTML = '<p>ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                 }
                 detailsEl.innerHTML = detailsHTML;
            }

            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
                if (localPlayer.isHost) {
                     hostProceedPhase();
                }
            }, timeoutDuration);
        }

        function showActionPopup(title, description, showCloseButton) {
            const popup = document.getElementById('action-popup');
            popup.querySelector('h2').innerText = title;
            popup.querySelector('p').innerText = description;
            
            const closeBtnHTML = `<button onclick="hideActionPopup()" class="popup-close-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>`;
            
            const panel = popup.querySelector('.screen-panel');
            const existingBtn = panel.querySelector('.popup-close-btn');
            if (existingBtn) existingBtn.remove();

            if (showCloseButton) {
                panel.insertAdjacentHTML('afterbegin', closeBtnHTML);
            }

            popup.classList.remove('hidden');
        }

        function showVotePopup(title, description, targets, action, maxTargets = 1) {
            const popup = document.getElementById('vote-popup');
            popup.querySelector('h2').innerText = title;
            popup.querySelector('p').innerText = description;
            
            let selectedTargets = [];
            const targetsEl = popup.querySelector('#vote-targets');

            const isDuplicateSelectionAllowed = maxTargets > 1 && title.includes('ê°ì—¼ í™œë™');

            const redrawSelections = () => {
                targets.forEach(p => {
                    const targetBtn = document.getElementById(`votebtn-${p.id}`);
                    if (!targetBtn) return;
                    const selectionCount = selectedTargets.filter(id => id === p.id).length;
                    
                    if (selectionCount > 0) {
                        targetBtn.classList.add('bg-cyan-500');
                        let badge = targetBtn.querySelector('.selection-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'selection-badge absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold';
                            targetBtn.classList.add('relative');
                            targetBtn.appendChild(badge);
                        }
                        badge.innerText = selectionCount;
                        badge.classList.remove('hidden');
                    } else {
                        targetBtn.classList.remove('bg-cyan-500');
                        const badge = targetBtn.querySelector('.selection-badge');
                        if (badge) badge.classList.add('hidden');
                    }
                });
                const confirmBtn = document.getElementById('vote-confirm-btn');
                if (confirmBtn) {
                     confirmBtn.disabled = selectedTargets.length !== maxTargets;
                     confirmBtn.innerText = `ì„ íƒ ì™„ë£Œ (${selectedTargets.length}/${maxTargets})`;
                }
            };
            
            window.selectTarget = (targetId) => {
                const index = selectedTargets.indexOf(targetId);

                if (!isDuplicateSelectionAllowed && index > -1) {
                    selectedTargets.splice(index, 1); // Deselect for non-duplicate mode
                } else {
                    if (selectedTargets.length < maxTargets) {
                        selectedTargets.push(targetId);
                    }
                }
                
                if (maxTargets === 1 && selectedTargets.length === 1) {
                    window[action](selectedTargets);
                } else {
                    redrawSelections();
                }
            };
            
            window.resetSelection = () => {
                selectedTargets = [];
                redrawSelections();
            };

            targets.sort((a, b) => a.number - b.number);
            targetsEl.innerHTML = targets.map(p => `
                <button id="votebtn-${p.id}" class="w-full text-left p-3 bg-gray-700/50 hover:bg-cyan-600 rounded-lg transition" onclick="selectTarget('${p.id}')">
                    <span class="font-bold text-lg">${p.number}. ${p.nickname}</span>
                </button>
            `).join('') + `
                <div id="vote-confirm-container" class="mt-4 ${maxTargets > 1 ? '' : 'hidden'}">
                    <div class="flex gap-2">
                        <button id="vote-confirm-btn" class="w-full btn-primary" disabled>ì„ íƒ ì™„ë£Œ (0/${maxTargets})</button>
                        <button onclick="resetSelection()" class="btn-secondary px-4">ì´ˆê¸°í™”</button>
                    </div>
                </div>
            `;

            const confirmBtn = document.getElementById('vote-confirm-btn');
            if(confirmBtn) {
                confirmBtn.onclick = () => {
                    window[action](selectedTargets);
                };
            }

            popup.classList.remove('hidden');
        }
        function hideActionPopup() {
            if (currentRoomId && !localPlayer.isHost && currentRoomData?.gameState?.isPlayerActing) {
                updateDoc(doc(db, 'rooms', currentRoomId), { 'gameState.isPlayerActing': false });
            }
            document.getElementById('action-popup').classList.add('hidden');
            document.getElementById('vote-popup').classList.add('hidden');
        }

        async function submitVote(targetIds) {
            if (!currentRoomId || targetIds.length === 0) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            const actorId = actingBotId || localPlayer.id;
            await updateDoc(roomRef, { [`votes.${actorId}`]: targetIds[0] });
            hideActionPopup();
            actingBotId = null;
        }
        async function submitNightAction(targetIds) {
            if (!currentRoomId) return;
            if (!Array.isArray(targetIds)) targetIds = [targetIds];
            
            const roomRef = doc(db, 'rooms', currentRoomId);
            const actorId = actingBotId || localPlayer.id;

            const updates = {};
            updates[`nightActions.${actorId}`] = { targetIds: targetIds };

            const me = currentRoomData.players[actorId];
            if (me && me.abilityCard === 'state_fission' && !me.hasUsedCard && targetIds.length > 1) {
                updates[`players.${actorId}.hasUsedCard`] = true;
            }

            await updateDoc(roomRef, updates);
            hideActionPopup();
            actingBotId = null;
        }

        // --- ê²Œì„ ì¢…ë£Œ ---
        function updateObservationUI(room) {
            const { players, gameState, gameMode } = room;
            const observationTextEl = document.getElementById('observation-text');
            const hostControlsEl = document.getElementById('host-observation-controls');
            const timerText = document.getElementById('observation-timer');
            const scrambleControlsEl = document.getElementById('scramble-controls');
            
            hostControlsEl.classList.add('hidden');
            scrambleControlsEl.classList.add('hidden');

            const me = players[localPlayer.id];
            const hasScrambleCard = me && me.abilityCard === 'state_scramble' && !me.hasUsedCard;

            if (gameState.subPhase === 'OBSERVATION') {
                if (hasScrambleCard) {
                    observationTextEl.innerText = "ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ìƒíƒœíŒì´ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹ ë¶„ êµë€ ì¥ì¹˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.";
                    scrambleControlsEl.classList.remove('hidden');
                } else {
                    observationTextEl.innerText = "ëª¨ë“  í”Œë ˆì´ì–´ì˜ ìµœì¢… ìƒíƒœíŒì´ ê³µê°œë©ë‹ˆë‹¤. 30ì´ˆ í›„ í˜¸ìŠ¤íŠ¸ê°€ ìš´ëª… ì¸¡ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
                }
            } else if (gameState.subPhase === 'MEASUREMENT_READY') {
                observationTextEl.innerText = "í˜¸ìŠ¤íŠ¸ê°€ ê° í”Œë ˆì´ì–´ì˜ ìš´ëª…ì„ ì¸¡ì •í•©ë‹ˆë‹¤.";
                timerText.innerText = "ì¸¡ì • ëŒ€ê¸° ì¤‘...";
            }
            
            const observationEl = document.getElementById('observation-player-list');
            observationEl.innerHTML = Object.values(players).sort((a,b)=>a.number - b.number).map(p => {
                const isSelf = p.id === localPlayer.id;
                const isBlinded = hasScrambleCard && !isSelf;

                const chipsHtml = isBlinded 
                    ? Array(6).fill('<div class="w-full h-4 rounded bg-gray-600 animate-pulse"></div>').join('')
                    : p.quantumState.map(chip => 
                        `<div class="w-full h-4 rounded ${chip === 'AEON' ? 'bg-red-500 neon-red-sm' : 'bg-blue-500 neon-blue-sm'}"></div>`
                      ).join('');
                
                const isMeasurable = localPlayer.isHost && !p.finalRole && p.isAlive && gameState.subPhase === 'MEASUREMENT_READY';
                
                let resultHtml = '';
                if(p.finalRole) {
                    const roleText = p.finalRole === 'AEON' ? 'ì—ì´ì˜¨' : 'ì¸ë¥˜ ì§„ì˜';
                    const colorClass = p.finalRole === 'AEON' ? 'text-red-400' : 'text-cyan-400';
                    resultHtml += `<span class="font-bold ${colorClass}">${roleText}</span>`;
                } else if (isMeasurable) {
                    resultHtml = `<span class="text-yellow-400 font-bold animate-pulse">ì¸¡ì •í•˜ê¸°</span>`;
                }

                if ((p.id === localPlayer.id || (isDevMode && localPlayer.isHost)) && p.finalRole && p.abilityCard === 'rule_remeasure' && !p.hasUsedCard) {
                    resultHtml += `<button onclick="requestRemeasure('${p.id}')" class="ml-2 bg-yellow-500 text-black text-xs font-bold py-1 px-2 rounded">ì¬ì¸¡ì •</button>`;
                }

                const panelClass = isMeasurable ? 'cursor-pointer hover:border-yellow-400 transition-all' : '';
                const onClickAction = isMeasurable ? `onclick="measurePlayer('${p.id}')"` : '';

                return `<div class="screen-panel p-3 ${panelClass}" ${onClickAction}>
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-lg">${p.number}. ${p.nickname}</span>
                                <div class="h-8 flex items-center justify-center">${resultHtml}</div>
                            </div>
                            <div class="grid grid-cols-6 gap-1 mt-2">${chipsHtml}</div>
                        </div>`;
            }).join('');
            
            if(gameTimerInterval) clearInterval(gameTimerInterval);
            let timer = gameState.timer;

            const allMeasured = Object.values(players).filter(p => p.isAlive).every(p => p.finalRole);
            if(allMeasured) {
                if(localPlayer.isHost) {
                    timerText.innerText = "5ì´ˆ í›„ ê²°ê³¼ë¥¼ ê³µê°œí•©ë‹ˆë‹¤...";
                    setTimeout(() => {
                        const roomRef = doc(db, 'rooms', currentRoomId);
                        updateDoc(roomRef, { 'gameState.subPhase': 'RESULT' });
                    }, 5000);
                }
                return;
            }
            
            if (gameState.subPhase === 'OBSERVATION' && !hasScrambleCard) {
                timerText.innerText = Math.max(0, timer);
                if (timer > 0) {
                    gameTimerInterval = setInterval(() => {
                        timer--;
                        timerText.innerText = Math.max(0, timer);
                        if (timer < 0) {
                            clearInterval(gameTimerInterval);
                            if (localPlayer.isHost) {
                                if (gameMode === 'classic') {
                                    const roomRef = doc(db, 'rooms', currentRoomId);
                                    updateDoc(roomRef, { 'gameState.subPhase': 'MEASUREMENT_READY' });
                                } else { 
                                    const hasCardsToPlay = currentRoomData.cardActions && Object.values(currentRoomData.cardActions).some(a => abilityCardDeck[a.cardId]?.timing === 'OBSERVATION');
                                    if (!hasCardsToPlay) {
                                        const roomRef = doc(db, 'rooms', currentRoomId);
                                        updateDoc(roomRef, { 'gameState.subPhase': 'MEASUREMENT_READY' });
                                    } else {
                                        timerText.innerText = "ì¹´ë“œ íš¨ê³¼ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘...";
                                        hostControlsEl.classList.remove('hidden');
                                    }
                                }
                            } else {
                                timerText.innerText = "í˜¸ìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...";
                            }
                        }
                    }, 1000);
                } else {
                    if (localPlayer.isHost) {
                        if (gameMode === 'classic') {
                            const roomRef = doc(db, 'rooms', currentRoomId);
                            updateDoc(roomRef, { 'gameState.subPhase': 'MEASUREMENT_READY' });
                        } else {
                            const hasCardsToPlay = currentRoomData.cardActions && Object.values(currentRoomData.cardActions).some(a => abilityCardDeck[a.cardId]?.timing === 'OBSERVATION');
                            if (!hasCardsToPlay) {
                                 const roomRef = doc(db, 'rooms', currentRoomId);
                                 updateDoc(roomRef, { 'gameState.subPhase': 'MEASUREMENT_READY' });
                            } else {
                                timerText.innerText = "ì¹´ë“œ íš¨ê³¼ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘...";
                                hostControlsEl.classList.remove('hidden');
                            }
                        }
                    } else {
                        timerText.innerText = "í˜¸ìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...";
                    }
                }
            } else if (hasScrambleCard) {
                timerText.innerText = "ê²°ì • ëŒ€ê¸° ì¤‘...";
            }
        }
        
        async function hostApplyObservationCards() {
             if (!currentRoomId || !localPlayer.isHost) return;
             const roomRef = doc(db, "rooms", currentRoomId);
             try {
                 await runTransaction(db, async (transaction) => {
                      const roomDoc = await transaction.get(roomRef);
                      if (!roomDoc.exists()) return;
                      let room = roomDoc.data();
                      let { players, cardActions } = room;
                      let newPlayers = JSON.parse(JSON.stringify(players));
                      let newLogEntries = [];
                      let lastSpecialEffect = null;

                      if (cardActions) {
                          for(const playerId in cardActions) {
                               const action = cardActions[playerId];
                               const card = abilityCardDeck[action.cardId];
                               if (card.timing === 'OBSERVATION') {
                                   const user = newPlayers[playerId];
                                   const targetId = action.targetIds[0];
                                   const target = newPlayers[targetId];
                                   
                                   if (action.cardId === 'state_scramble' && user && target && playerId !== targetId) {
                                       const userState = [...user.quantumState];
                                       newPlayers[playerId].quantumState = [...target.quantumState];
                                       newPlayers[targetId].quantumState = userState;
                                       newLogEntries.push({ round: 'ì¢…ë£Œ', phase: 'ê´€ì¸¡', hostText: `${user.nickname}ë‹˜ì´ [ì‹ ë¶„ êµë€ ì¥ì¹˜]ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, playerText: `[ì‹ ë¶„ êµë€ ì¥ì¹˜]ê°€ ë°œë™í•˜ì—¬ ëˆ„êµ°ê°€ì˜ ìƒíƒœíŒì´ ë’¤ë°”ë€Œì—ˆìŠµë‹ˆë‹¤.`});
                                       lastSpecialEffect = { cardId: 'state_scramble', userNickname: user.nickname };
                                   }
                               }
                          }
                      }
                      transaction.update(roomRef, {
                          players: newPlayers,
                          'gameState.subPhase': 'MEASUREMENT_READY',
                          'gameState.lastSpecialEffect': lastSpecialEffect,
                          eventLog: arrayUnion(...newLogEntries)
                      });
                 });
             } catch (e) {
                 console.error("Error applying observation cards:", e);
             }
        }


        async function measurePlayer(playerId) {
          if (!localPlayer.isHost) return;
          const roomRef = doc(db, 'rooms', currentRoomId);
          const playerToMeasure = currentRoomData.players[playerId];
          if (!playerToMeasure || playerToMeasure.finalRole) return;
          
          const state = playerToMeasure.quantumState;
          const aeonStickers = state.filter(s => s === 'AEON').length;
          const probability = aeonStickers / 6;
          const isAeon = Math.random() < probability;
          const finalRole = isAeon ? 'AEON' : 'CITIZEN';

          await updateDoc(roomRef, { [`players.${playerId}.finalRole`]: finalRole });
        }
        
        async function requestRemeasure(playerId) {
            if (!currentRoomId) return;
            const targetPlayerId = playerId || localPlayer.id;
            const me = currentRoomData.players[targetPlayerId];
            if (me.abilityCard !== 'rule_remeasure' || me.hasUsedCard) return;

            const roomRef = doc(db, 'rooms', currentRoomId);
            await updateDoc(roomRef, {
                [`players.${targetPlayerId}.finalRole`]: null,
                [`players.${targetPlayerId}.hasUsedCard`]: true
            });
            showCustomAlert('ì¬ì¸¡ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ì‹œ ì¸¡ì •í•  ê²ƒì…ë‹ˆë‹¤.');
        }


        function updateEndResultUI(room) {
            const { players } = room;
            
            const finalPlayers = Object.values(players).filter(p => p.isAlive);
            const aeonCount = finalPlayers.filter(p => p.finalRole === 'AEON').length;
            const citizenCount = finalPlayers.filter(p => p.finalRole !== 'AEON').length;
            const winTeam = aeonCount >= citizenCount ? 'AEON' : 'CITIZEN';

            const winnerList = [];
            const entangledPairs = room.entangledPairs || [];
            const entangledPlayerIds = entangledPairs.flat();
            
            // ì–½íˆì§€ ì•Šì€ í”Œë ˆì´ì–´ ìŠ¹ë¦¬ íŒì •
            finalPlayers.forEach(p => {
                if (!entangledPlayerIds.includes(p.id)) {
                    if ((p.finalRole === 'AEON' && winTeam === 'AEON') || (p.finalRole !== 'AEON' && winTeam === 'CITIZEN')) {
                        winnerList.push(p);
                    }
                }
            });

            // ì–½íŒ í”Œë ˆì´ì–´ ìŠ¹ë¦¬ íŒì •
            entangledPairs.forEach(pair => {
                const player1 = players[pair[0]];
                const player2 = players[pair[1]];
                if (player1 && player2 && player1.finalRole && player2.finalRole && player1.finalRole !== player2.finalRole) {
                    if (!winnerList.find(w => w.id === player1.id)) winnerList.push(player1);
                    if (!winnerList.find(w => w.id === player2.id)) winnerList.push(player2);
                }
            });

            document.getElementById('end-title').innerText = winTeam === 'CITIZEN' ? 'ì¸ë¥˜ì˜ ê³¼í•™ì„ ì§€ì¼œëƒˆìŠµë‹ˆë‹¤!' : 'ì—ì´ì˜¨ì´ ê³¼í•™ ë°œì „ì„ ì €ì§€í–ˆìŠµë‹ˆë‹¤!';
            
            const resultsEl = document.getElementById('final-player-list');
            resultsEl.innerHTML = `
                <h3 class="text-xl font-bold mb-4">ìŠ¹ë¦¬í•œ í”Œë ˆì´ì–´</h3>
                ${winnerList.map(p => `<div class="text-lg">${p.number}. ${p.nickname} (${p.finalRole === 'AEON' ? 'ì—ì´ì˜¨' : 'ì¸ë¥˜ ì§„ì˜'})</div>`).join('') || 'ìŠ¹ë¦¬í•œ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            `;
            
            if(localPlayer.isHost) {
                 setTimeout(() => {
                      backToLobby();
                 }, 15000);
            }
        }
        async function backToLobby() {
            if (!currentRoomId || !localPlayer.isHost) { 
                showScreen('main-menu-screen'); 
                return; 
            }
            try {
                const roomRef = doc(db, 'rooms', currentRoomId);
                const docSnap = await getDoc(roomRef);
                if(docSnap.exists()) {
                    const originalPlayers = docSnap.data().players;
                    Object.keys(originalPlayers).forEach(id => {
                        originalPlayers[id] = {
                            ...originalPlayers[id],
                            isAlive: true,
                            isReady: id === localPlayer.id, // í˜¸ìŠ¤íŠ¸ë§Œ ì¤€ë¹„ ìƒíƒœ
                            quantumState: [],
                            finalRole: null,
                            initialRole: null,
                            currentRole: null,
                            abilityCard: null,
                            hasUsedCard: false
                        };
                    });
                    await updateDoc(roomRef, { 
                        status: 'waiting', 
                        gameState: deleteField(),
                        votes: deleteField(),
                        nightActions: deleteField(),
                        cardActions: deleteField(),
                        cardActionResults: deleteField(),
                        entangledPairs: deleteField(),
                        players: originalPlayers 
                    });
                }
            } catch (e) {
                console.error("Error returning to lobby: ", e);
            }
        }

        // --- ê°œë°œì ëª¨ë“œ ì „ìš© í•¨ìˆ˜ ---
        function addBotPlayer() {
            if (!isDevMode || !localPlayer.isHost) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) return;
                const room = roomDoc.data();
                const playerCount = Object.keys(room.players).length;
                if (playerCount >= 12) return;

                const existingNumbers = Object.values(room.players).map(p => p.number);
                let newPlayerNumber = 1;
                while(existingNumbers.includes(newPlayerNumber)) { newPlayerNumber++; }
                
                const botId = `bot_${Date.now()}`;
                const botData = { id: botId, nickname: `Bot ${newPlayerNumber}`, isReady: true, number: newPlayerNumber, isAlive: true, quantumState: [], finalRole: null, initialRole: null, currentRole: null, abilityCard: null, hasUsedCard: false };
                transaction.update(roomRef, { [`players.${botId}`]: botData });
            });
        };

        function hostControlBot(botId, controlType) {
            if (!isDevMode || !localPlayer.isHost) return;
            actingBotId = botId; 
            const room = currentRoomData;
            const bot = room.players[botId];

            if (controlType === 'VOTE') {
                let voteTargets;
                let message = "ì¹˜ë£Œì œë¥¼ íˆ¬ì—¬í•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”.";
                if (room.gameState.revoteCandidates && room.gameState.revoteCandidates.length > 0) {
                    voteTargets = Object.values(room.players).filter(p => p.isAlive && room.gameState.revoteCandidates.includes(p.id));
                    message = `[${bot.nickname} ëŒ€ì‹  íˆ¬í‘œ] ìµœë‹¤ ë“í‘œì ì¤‘ì—ì„œ ì„ íƒí•˜ì„¸ìš”.`;
                } else {
                    voteTargets = Object.values(room.players).filter(p => p.isAlive);
                    message = `[${bot.nickname} ëŒ€ì‹  íˆ¬í‘œ] ì¹˜ë£Œì œë¥¼ íˆ¬ì—¬í•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”.`;
                }
                showVotePopup(`ë‚® íˆ¬í‘œ (ë´‡ ì œì–´)`, message, voteTargets, 'submitVote');
            } else if (controlType === 'ACTION') {
                const actionTargets = Object.values(room.players).filter(p => p.isAlive);
                let title = bot.currentRole === 'AEON' ? `ê°ì—¼ í™œë™` : `ë³´í˜¸ í™œë™`;
                let desc = bot.currentRole === 'AEON' ? `[${bot.nickname} ëŒ€ì‹  íˆ¬í‘œ] ê°ì—¼ì‹œí‚¬ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.` : `[${bot.nickname} ëŒ€ì‹  íˆ¬í‘œ] ë³´í˜¸í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.`;
                showVotePopup(`${title} (ë´‡ ì œì–´)`, desc, actionTargets, 'submitNightAction');
            }
        };

        function hostControlBotCard(botId) {
            if (!isDevMode || !localPlayer.isHost) return;
            actingBotId = botId;
            const bot = currentRoomData.players[botId];
            const card = abilityCardDeck[bot.abilityCard];
            showCustomAlertWithHTML(`'${bot.nickname}'ì˜ '${card.name}' ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br/><br/> <div class="flex justify-center gap-4"><button onclick="confirmUseCard(true)" class="btn-primary">ì˜ˆ</button><button onclick="hideCustomAlert()" class="btn-secondary">ì•„ë‹ˆìš”</button></div>`);
        };

        // --- ìœ í‹¸ë¦¬í‹° ---
        function showCustomAlert(message) {
            document.getElementById('custom-alert-text').innerHTML = message;
            document.getElementById('custom-alert-popup').classList.remove('hidden');
            playSound('popupOpen');
        }
        function showCustomAlertWithHTML(html) { // HTML ë Œë”ë§ì„ ìœ„í•œ ë³„ë„ í•¨ìˆ˜
            document.getElementById('custom-alert-text').innerHTML = html;
            document.getElementById('custom-alert-popup').classList.remove('hidden');
            playSound('popupOpen');
        }
        function hideCustomAlert() {
            playSound('click');
            document.getElementById('custom-alert-popup').classList.add('hidden');
        }

        // --- ë³„ ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ ---
        function startStarfield() {
            const canvas = document.getElementById('starfield-bg');
            const ctx = canvas.getContext('2d');

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            const stars = [];
            const numStars = 200;

            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5
                });
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = "lighter";

                for (let i = 0, x = stars.length; i < x; i++) {
                    const s = stars[i];
                    ctx.fillStyle = "#1e90ff";
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.radius, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }

            function update() {
                for (let i = 0, x = stars.length; i < x; i++) {
                    const s = stars[i];
                    s.x += s.vx;
                    s.y += s.vy;
                    if (s.x < 0 || s.x > canvas.width) s.x = (s.x < 0) ? canvas.width : 0;
                    if (s.y < 0 || s.y > canvas.height) s.y = (s.y < 0) ? canvas.height : 0;
                }
            }

            function tick() {
                draw();
                update();
                requestAnimationFrame(tick);
            }
            tick();
        }
        
        // --- ì¹´ì˜¤ìŠ¤ ëª¨ë“œ ê´€ë ¨ í•¨ìˆ˜ ---
        function applyCardEffects(cardActions, players, gameState, logEntries) {
            const cardActionResults = {};
            let newGameState = {...gameState};

            for(const playerId in cardActions) {
                const action = cardActions[playerId];
                const user = players[playerId];
                const targetId = action.targetIds[0];
                const target = players[targetId];

                switch(action.cardId) {
                    case 'info_heisenberg':
                        cardActionResults[playerId] = { cardId: action.cardId, targetId: targetId };
                        // ìƒíƒœ êµë€ ë¡œì§
                        const userState = user.quantumState;
                        if (userState.length > 0) {
                            const randomIndex = Math.floor(Math.random() * userState.length);
                            userState[randomIndex] = userState[randomIndex] === 'AEON' ? 'CITIZEN' : 'AEON';
                        }
                        logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ì´ [í•˜ì´ì  ë² ë¥´í¬ ê´€ì¸¡ê¸°] ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ì´ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`});
                        break;
                    case 'info_trace':
                        cardActionResults[playerId] = { cardId: action.cardId, details: null };
                        logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ì´ [ì•”í˜¸ í•´ë…ê¸°] ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ì´ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`});
                        break;
                    case 'state_infect':
                        if(target) {
                            const citizenIndex = target.quantumState.indexOf('CITIZEN');
                            if(citizenIndex > -1) {
                                target.quantumState[citizenIndex] = 'AEON';
                                logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ì´ ${target.nickname}ë‹˜ì—ê²Œ [ë°ì´í„° ì˜¤ì—¼]ì„ ì‚¬ìš©í•´ ìƒíƒœë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ì´ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`});
                            }
                        }
                        break;
                    case 'state_heal':
                         if(target) {
                            const aeonIndex = target.quantumState.indexOf('AEON');
                            if(aeonIndex > -1) {
                                target.quantumState[aeonIndex] = 'CITIZEN';
                                logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ì´ ${target.nickname}ë‹˜ì—ê²Œ [ë°ì´í„° ë³µêµ¬]ë¥¼ ì‚¬ìš©í•´ ìƒíƒœë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ì´ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`});
                            }
                        }
                        break;
                    case 'rule_entangle':
                        if (target) {
                            if (!newGameState.entangledPairs) newGameState.entangledPairs = [];
                            newGameState.entangledPairs.push([playerId, targetId]);
                             logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ê³¼ ${target.nickname}ë‹˜ì´ [ì–‘ì ì–½í˜] ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ê³¼ ${target.nickname}ë‹˜ì´ [ì–‘ì ì–½í˜] ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`});
                        }
                        break;
                    case 'rule_firewall':
                        newGameState.isFirewallActive = true;
                        logEntries.push({round: gameState.round, phase: 'ë‚®', hostText: `${user.nickname}ë‹˜ì´ [ë°©í™”ë²½]ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, playerText: `${user.nickname}ë‹˜ì´ [ë°©í™”ë²½]ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`});
                        break;
                }
            }
            return { players, cardActionResults, gameState: newGameState };
        }


        function isCardUsableNow(card, gameState) {
            if (!card || card.timing === 'PASSIVE') return false;
            
            if (gameState.phase === 'END' && card.timing === 'OBSERVATION') {
                return true;
            }
            
            if(card.name === 'ì¸ê³¼ìœ¨ êµë€ê¸°') {
                const actorId = actingBotId || localPlayer.id;
                const me = currentRoomData.players[actorId];
                return gameState.phase === 'END' && me.finalRole;
            }

            return card.timing === gameState.subPhase;
        }

        function handleCardClick() {
            playSound('click');
            if (currentRoomData.gameState.isPlayerActing) {
                showCustomAlert('ë‹¤ë¥¸ í”Œë ˆì´ì–´ê°€ ë¨¼ì € ì¹´ë“œë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            const me = currentRoomData.players[localPlayer.id];
            const card = abilityCardDeck[me.abilityCard];
            showCustomAlertWithHTML(`'${card.name}' ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br/><br/> <div class="flex justify-center gap-4"><button onclick="confirmUseCard(false)" class="btn-primary">ì˜ˆ</button><button onclick="hideCustomAlert()" class="btn-secondary">ì•„ë‹ˆìš”</button></div>`);
        }

        async function confirmUseCard(isBotAction = false) {
            playSound('click');
            hideCustomAlert();
            const actorId = isBotAction ? actingBotId : localPlayer.id;
            if (!actorId) {
                if(isBotAction) actingBotId = null;
                return;
            }
            const roomRef = doc(db, 'rooms', currentRoomId);
            await updateDoc(roomRef, { 'gameState.isPlayerActing': true });

            const actor = currentRoomData.players[actorId];
            const card = abilityCardDeck[actor.abilityCard];
            
            if (card.needsTarget) {
                let targets = Object.values(currentRoomData.players).filter(p => p.isAlive);
                if (card.name === 'ì‹ ë¶„ êµë€ ì¥ì¹˜') {
                    // ìì‹ ë„ í¬í•¨
                } else if (card.timing === 'OBSERVATION' || card.name === 'ì–‘ì ì–½í˜') {
                    targets = targets.filter(p => p.id !== actorId);
                }
                const title = isBotAction ? `[${actor.nickname} ì‚¬ìš©] ${card.name}` : `[${card.name}] ëŒ€ìƒ ì„ íƒ`;
                showVotePopup(title, "ëŠ¥ë ¥ì„ ì‚¬ìš©í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.", targets, 'submitCardAction', card.maxTargets || 1);
            } else {
                submitCardAction([]); 
            }
        }

        async function submitCardAction(targetIds) {
            if (!currentRoomId) return;
            hideActionPopup(); 
            
            if (!Array.isArray(targetIds)) targetIds = [targetIds].filter(t => t !== null);

            const actorId = actingBotId || localPlayer.id;
            const actor = currentRoomData.players[actorId];
            const cardId = actor.abilityCard;
            if (!cardId || actor.hasUsedCard) {
                showCustomAlert("ì¹´ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (actingBotId) actingBotId = null;
                const roomRef = doc(db, 'rooms', currentRoomId);
                await updateDoc(roomRef, { 'gameState.isPlayerActing': false });
                return;
            }
            const roomRef = doc(db, 'rooms', currentRoomId);
            const updates = {
                [`cardActions.${actorId}`]: { cardId: cardId, targetIds: targetIds, userNickname: actor.nickname },
                [`players.${actorId}.hasUsedCard`]: true,
                'gameState.isPlayerActing': false
            };
            await updateDoc(roomRef, updates);
            
            const card = abilityCardDeck[cardId];
            if (card.type === 'state') {
                 showCardUseEffect(card.name, 'ìƒíƒœíŒì„ ë³€ê²½í•©ë‹ˆë‹¤...');
            }

            if (actingBotId) actingBotId = null;

            if (cardId === 'info_trace') {
                showCustomAlert("'ì•”í˜¸ í•´ë…ê¸°' ì‚¬ìš©ì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°¤ì´ ëë‚œ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.");
            } else {
                 if(cardId !== 'info_heisenberg') {
                    showCustomAlert("ì¹´ë“œ ëŠ¥ë ¥ì„ ì‚¬ìš© ì˜ˆì•½í–ˆìŠµë‹ˆë‹¤.");
                 }
            }
        }

        function showRoleRevealPopup() {
            const popup = document.getElementById('role-reveal-popup');
            const nameEl = document.getElementById('role-reveal-name');
            const roleEl = document.getElementById('role-reveal-text');
            
            let roleText = "ì•Œ ìˆ˜ ì—†ìŒ";
            if (myInitialRoleForReveal === 'AEON') roleText = "ì—ì´ì˜¨";
            else if (myInitialRoleForReveal === 'DEVELOPER') roleText = "ë°±ì‹  ê°œë°œì";
            else if (myInitialRoleForReveal === 'CITIZEN') roleText = "ê³¼í•™ì";

            nameEl.innerText = localPlayer.nickname;
            roleEl.innerText = roleText;
            
            popup.classList.remove('hidden');
            playSound('roleReveal');

            setTimeout(() => {
                popup.classList.add('hidden');
                showScreen('game-screen');
                updateGameUI(currentRoomData);
            }, 4000);
        }

        function showPhaseTransition(message) {
            const overlay = document.getElementById('phase-transition-overlay');
            const textEl = document.getElementById('phase-transition-text');
            textEl.innerText = message;
            overlay.classList.remove('hidden');
            playSound('phaseChange');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 2800);
        }

        function showCardUseEffect(cardName, subtitle, duration = 2500) {
            const overlay = document.getElementById('card-effect-overlay');
            document.getElementById('card-effect-name').innerText = cardName;
            document.getElementById('card-effect-subtitle').innerText = subtitle;
            overlay.classList.remove('hidden');
            playSound('cardEffect');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, duration);
        }
        
        // --- ì´ˆê¸°í™” ë° ì „ì—­ í• ë‹¹ ---
        window.onload = () => {
            initializeSounds();
            startStarfield(); 

            // URL íŒŒë¼ë¯¸í„°ë¡œ ê°œë°œì ëª¨ë“œ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            isDevMode = urlParams.get('dev') === 'true';
            if (isDevMode) {
                console.warn("ê°œë°œì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            
            // Firebase ì´ˆê¸°í™”
            try {
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    console.warn("ë¡œì»¬ ê°œë°œìš© Firebase ì„ì‹œ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë°°í¬ ì‹œì—ëŠ” ì‹¤ì œ ì„¤ì •ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.");
                    // ë¡œì»¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„ì‹œ Firebase ì„¤ì •
                    firebaseConfig = {
                        apiKey: "AIzaSyCrgCH3e-lmd79bb-aU74QfZUfvI8_m0vI",
                        authDomain: "aeon-game-726d8.firebaseapp.com",
                        projectId: "aeon-game-726d8",
                        storageBucket: "aeon-game-726d8.appspot.com",
                        messagingSenderId: "1031494860943",
                        appId: "1:1031494860943:web:ca3acac820e0e67a4830fa"
                    };
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        localPlayer.id = user.uid;
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("Custom token sign-in failed, falling back to anonymous", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 1.2rem;">Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('create-room-btn').addEventListener('click', () => { playSound('click'); showScreen('create-mode-selection-screen'); });
            document.getElementById('join-room-btn').addEventListener('click', () => { playSound('click'); showScreen('join-mode-selection-screen'); });
            document.getElementById('close-popup-btn').addEventListener('click', hideCreateRoomPopup);
            document.getElementById('submit-create-room-btn').addEventListener('click', createRoom);
            document.getElementById('nickname-submit-btn').addEventListener('click', setNicknameAndShowMain);
            document.getElementById('ready-btn').addEventListener('click', toggleReady);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('back-to-lobby-btn').addEventListener('click', () => { playSound('click'); backToLobby(); });
            document.getElementById('back-to-main-menu-btn').addEventListener('click', () => {
                playSound('click');
                if (roomListUnsubscribe) roomListUnsubscribe();
                showScreen('main-menu-screen');
            });
            document.getElementById('back-to-main-from-create-select').addEventListener('click', () => { playSound('click'); showScreen('main-menu-screen'); });
            document.getElementById('back-to-main-from-join-select').addEventListener('click', () => { playSound('click'); showScreen('main-menu-screen'); });
            document.getElementById('leave-room-btn-lobby').addEventListener('click', showConfirmLeavePopup);
            document.getElementById('leave-room-btn-game').addEventListener('click', showConfirmLeavePopup);
            document.getElementById('cancel-leave-btn').addEventListener('click', hideConfirmLeavePopup);
            document.getElementById('confirm-leave-btn').addEventListener('click', () => { playSound('click'); leaveRoom(false); });
            document.getElementById('host-proceed-btn').addEventListener('click', () => { playSound('click'); hostProceedPhase(); });
            document.getElementById('host-skip-timer-btn').addEventListener('click', () => { playSound('click'); hostProceedPhase(); });
            document.getElementById('host-apply-observation-cards-btn').addEventListener('click', () => { playSound('click'); hostApplyObservationCards(); });
            document.getElementById('host-skip-vote-btn').addEventListener('click', () => { playSound('click'); hostProceedPhase(); });
            document.getElementById('rulebook-btn-main').addEventListener('click', showRulebookPopup);
            document.getElementById('rulebook-btn-game').addEventListener('click', showRulebookPopup);
            document.getElementById('close-rulebook-btn').addEventListener('click', hideRulebookPopup);
            document.getElementById('close-custom-alert-btn').addEventListener('click', hideCustomAlert);
            document.getElementById('event-log-btn').addEventListener('click', showEventLogPopup);
            document.getElementById('close-event-log-btn').addEventListener('click', hideEventLogPopup);
            document.getElementById('scramble-use-btn').addEventListener('click', handleCardClick);
            
            showScreen('nickname-screen');
        };
        
        window.selectCreateMode = (mode) => {
            playSound('click');
            selectedGameMode = mode;
            showCreateRoomPopup();
        };
        window.selectJoinMode = (mode) => {
            playSound('click');
            showRoomList(mode);
        };
        window.joinRoom = joinRoom;
        window.addBotPlayer = addBotPlayer;
        window.hostControlBot = hostControlBot;
        window.hostControlBotCard = hostControlBotCard;
        window.measurePlayer = measurePlayer;
        window.requestRemeasure = requestRemeasure;
        window.handleCardClick = handleCardClick;
        window.confirmUseCard = confirmUseCard;
        window.submitCardAction = submitCardAction;
        window.hideActionPopup = hideActionPopup;
        window.submitVote = submitVote;
        window.submitNightAction = submitNightAction;
        window.hideCustomAlert = hideCustomAlert;
        window.setTotalRounds = async (rounds) => {
            playSound('click');
            if (!currentRoomId || !localPlayer.isHost) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            try {
                await updateDoc(roomRef, { totalRounds: rounds });
            } catch (error) {
                console.error("Error setting total rounds:", error);
            }
        };


    </script>
    <style>
        :root {
            --bg-color: #0c1427;
            --primary-cyan: #22d3ee;
            --primary-orange: #f97316;
            --font-title: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-color);
            color: #e2e8f0;
        }
        #starfield-bg {
            position: fixed;
            top: 0; left: 0;
            z-index: -1;
            opacity: 0.5;
        }
        .title-text {
            font-family: var(--font-title);
            color: var(--primary-cyan);
            text-shadow: 0 0 5px var(--primary-cyan), 0 0 10px var(--primary-cyan);
        }
        .screen-panel {
            background-color: rgba(12, 20, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary-cyan);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3), inset 0 0 15px rgba(34, 211, 238, 0.2);
            padding: 1rem;
            border-radius: 1rem;
        }
        @media (min-width: 640px) {
            .screen-panel {
                padding: 2rem;
            }
        }
        .screen-panel-item {
            background-color: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(34, 211, 238, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .screen-panel-item:hover {
            background-color: rgba(34, 211, 238, 0.2);
            border-color: var(--primary-cyan);
        }
        .btn-primary {
            background-color: var(--primary-cyan);
            color: var(--bg-color);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #5ff5ff;
            box-shadow: 0 0 15px #5ff5ff;
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--primary-cyan);
            border: 1px solid var(--primary-cyan);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: rgba(34, 211, 238, 0.2);
        }
        #vote-targets button.bg-cyan-500 {
            border: 2px solid #67e8f9;
            box-shadow: 0 0 10px #67e8f9;
        }
        .neon-cyan { box-shadow: 0 0 15px var(--primary-cyan), 0 0 30px var(--primary-cyan); }
        .neon-red-sm { box-shadow: 0 0 5px #F43F5E, 0 0 10px #F43F5E; }
        .neon-blue-sm { box-shadow: 0 0 5px #38BDF8, 0 0 10px #38BDF8; }
        .animate-pulse-slow { animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-slow { 50% { opacity: .7; } }
        #observation-player-list:not(.measurement-ready) button { display: none; }
        #night-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(12, 20, 39, 0.7);
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #night-overlay.active {
            opacity: 1;
        }
        .popup-overlay {
            background-color: rgba(0,0,0,0.2);
            animation: fade-in 0.3s ease-out forwards;
        }
        .popup-panel {
            animation: scale-in 0.3s ease-out forwards;
        }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .glitch-line {
            height: 2px;
            width: 100%;
            background-color: var(--primary-cyan);
            animation: glitch 1.5s infinite;
        }
        @keyframes glitch {
            0% { transform: scaleX(1); }
            2% { transform: scaleX(0.2) translateX(-50%); }
            4% { transform: scaleX(1) translateX(0); }
            30% { transform: scaleX(1) translateX(0); }
            32% { transform: scaleX(0.5) translateX(50%); }
            34% { transform: scaleX(1) translateX(0); }
            100% { transform: scaleX(1); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <canvas id="starfield-bg"></canvas>
    <div id="night-overlay"></div>
    <div id="app-container" class="min-h-screen flex justify-center p-4 sm:p-6 pt-10 sm:pt-16 pb-20 relative">
        <div id="nickname-screen" class="screen w-full max-w-md">
            <div class="screen-panel">
                <h1 class="title-text text-3xl font-bold text-center mb-2">ì—ì´ì „íŠ¸ ì½”ë“œëª…</h1>
                <p class="text-center text-gray-400 mb-6">ê²Œì„ì—ì„œ ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                <input id="nickname-input" type="text" placeholder="ìµœëŒ€ 10ì" maxlength="10" class="w-full bg-gray-900/50 text-white p-3 rounded-lg text-center text-xl focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-500/50">
                <button id="nickname-submit-btn" class="w-full mt-6 btn-primary">
                    ì…ë ¥ ì™„ë£Œ
                </button>
            </div>
             <p class="text-center text-gray-600 mt-4 text-sm font-orbitron">aeon ver 1.18</p>
        </div>
        <div id="main-menu-screen" class="screen hidden w-full max-w-md">
            <div class="screen-panel text-center">
                 <h1 class="title-text text-4xl sm:text-5xl font-bold text-center mb-8">QUANTUM MAFIA</h1>
                 <div class="space-y-4">
                      <button id="create-room-btn" class="w-full btn-primary text-xl sm:text-2xl py-3 sm:py-4">
                           ê²Œì„ë°© ë§Œë“¤ê¸°
                      </button>
                      <button id="join-room-btn" class="w-full btn-secondary text-xl sm:text-2xl py-3 sm:py-4">
                           ê²Œì„ë°© ì°¸ê°€
                      </button>
                      <button id="rulebook-btn-main" class="w-full btn-secondary text-lg sm:text-xl py-2 sm:py-3">ê²Œì„ ë£°ë¶</button>
                 </div>
            </div>
        </div>
        <div id="create-mode-selection-screen" class="screen hidden w-full max-w-2xl">
            <div class="screen-panel text-center">
                 <h2 class="title-text text-3xl font-bold text-center mb-6">ê²Œì„ ëª¨ë“œ ì„ íƒ</h2>
                 <div class="grid md:grid-cols-2 gap-4">
                   <div class="screen-panel-item text-left" onclick="selectCreateMode('classic')">
                       <h3 class="font-bold text-2xl text-cyan-300 font-orbitron">í´ë˜ì‹ ëª¨ë“œ</h3>
                       <p class="text-gray-400 mt-2">íŠ¹ë³„í•œ ì´ë²¤íŠ¸ ì—†ì´, í”Œë ˆì´ì–´ë“¤ì˜ ìˆœìˆ˜í•œ ì¶”ë¦¬ì™€ ì‹¬ë¦¬ì „ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” ê¸°ë³¸ ëª¨ë“œì…ë‹ˆë‹¤.</p>
                   </div>
                   <div class="screen-panel-item text-left" onclick="selectCreateMode('chaos')">
                       <h3 class="font-bold text-2xl text-cyan-300 font-orbitron">ì¹´ì˜¤ìŠ¤ ëª¨ë“œ</h3>
                       <p class="text-gray-400 mt-2">ëª¨ë“  í”Œë ˆì´ì–´ê°€ íŠ¹ìˆ˜ ëŠ¥ë ¥ ì¹´ë“œë¥¼ ë°›ê³  ì‹œì‘í•˜ì—¬ ê²Œì„ì— ìƒˆë¡œìš´ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ëŠ” ëª¨ë“œì…ë‹ˆë‹¤.</p>
                   </div>
                 </div>
                 <button id="back-to-main-from-create-select" class="w-full mt-6 btn-secondary">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
        <div id="join-mode-selection-screen" class="screen hidden w-full max-w-2xl">
            <div class="screen-panel text-center">
                 <h2 class="title-text text-3xl font-bold text-center mb-6">ì°¸ê°€í•  ëª¨ë“œ ì„ íƒ</h2>
                 <div class="grid md:grid-cols-2 gap-4">
                   <div class="screen-panel-item text-left" onclick="selectJoinMode('classic')">
                       <h3 class="font-bold text-2xl text-cyan-300 font-orbitron">í´ë˜ì‹ ëª¨ë“œ</h3>
                   </div>
                   <div class="screen-panel-item text-left" onclick="selectJoinMode('chaos')">
                       <h3 class="font-bold text-2xl text-cyan-300 font-orbitron">ì¹´ì˜¤ìŠ¤ ëª¨ë“œ</h3>
                   </div>
                 </div>
                 <button id="back-to-main-from-join-select" class="w-full mt-6 btn-secondary">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
        <div id="room-list-screen" class="screen hidden w-full max-w-2xl">
             <div class="screen-panel">
                <h2 class="title-text text-3xl font-bold text-center mb-6">ê²Œì„ë°© ëª©ë¡</h2>
                <div id="room-list-container" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                </div>
                 <button id="back-to-main-menu-btn" class="w-full mt-6 btn-secondary">
                      ë’¤ë¡œê°€ê¸°
                 </button>
            </div>
        </div>
        <div id="lobby-screen" class="screen hidden w-full max-w-6xl">
            <div class="screen-panel relative">
                <button id="leave-room-btn-lobby" class="absolute top-4 left-4 text-gray-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                </button>
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="title-text text-2xl md:text-3xl font-bold">ê²Œì„ ë¡œë¹„</h2>
                        <p id="lobby-player-count" class="text-gray-400">í”Œë ˆì´ì–´: 0/4/12</p>
                    </div>
                    <div id="host-info" class="flex items-center space-x-2 text-lg text-gray-300">
                    </div>
                    <div class="text-right">
                        <p class="text-gray-400">ë°© ID</p>
                        <div class="flex items-center">
                            <span id="lobby-room-id" class="text-xl md:text-2xl font-bold text-yellow-400 tracking-widest">...</span>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('lobby-room-id').innerText); showCustomAlert('ë°© IDê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.')" class="ml-2 p-1 text-gray-400 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-copy"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col lg:flex-row justify-between items-start mb-8 gap-4">
                    <div id="player-slots" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 flex-grow w-full">
                    </div>
                    <div id="game-settings" class="ml-0 lg:ml-8 w-full lg:w-auto flex-shrink-0">
                         <div id="round-info" class="text-lg text-gray-300 mb-4 text-center lg:text-left"></div>
                         <div id="round-selection-container" class="text-center hidden">
                            <h3 class="text-lg font-bold text-cyan-300 mb-2">ë¼ìš´ë“œ ì„¤ì •</h3>
                            <div class="flex justify-center space-x-2">
                                <button id="round-btn-4" onclick="setTotalRounds(4)" class="btn-secondary px-4 py-2">4</button>
                                <button id="round-btn-5" onclick="setTotalRounds(5)" class="btn-secondary px-4 py-2">5</button>
                                <button id="round-btn-6" onclick="setTotalRounds(6)" class="btn-secondary px-4 py-2">6</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center items-center">
                    <button id="ready-btn" class="hidden bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 px-10 rounded-2xl text-2xl transition-all duration-300 transform hover:scale-105">ì¤€ë¹„</button>
                    <button id="start-game-btn" disabled class="hidden bg-red-600 text-white font-bold py-4 px-10 rounded-2xl text-2xl transition-all duration-300 opacity-50 cursor-not-allowed">ê²Œì„ ì‹œì‘</button>
                </div>
            </div>
        </div>
        <div id="game-screen" class="screen hidden w-full p-2 sm:p-4 flex flex-col">
             <div id="hud" class="screen-panel flex flex-col sm:flex-row justify-between items-center p-2 gap-2 flex-shrink-0">
                <div id="hud-player-info" class="flex items-center space-x-2 text-cyan-400 text-sm sm:text-base"></div>
                <div id="hud-phase" class="text-lg sm:text-2xl font-bold text-yellow-400 font-orbitron text-center"></div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div id="hud-role" class="flex items-center space-x-2 text-cyan-400 text-sm sm:text-base"></div>
                    <button id="rulebook-btn-game" class="text-gray-400 hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open-text"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/><path d="M6 8h2"/><path d="M6 12h2"/><path d="M16 8h2"/><path d="M16 12h2"/></svg>
                    </button>
                     <button id="leave-room-btn-game" class="text-gray-400 hover:text-white transition">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                     </button>
                </div>
            </div>
            <div id="game-main-content" class="flex-grow my-2 sm:my-4 grid grid-cols-1 lg:grid-cols-2 gap-4 content-start pr-2">
            </div>
            <div id="host-controls" class="w-full text-center py-2 flex-shrink-0 flex justify-center items-center gap-4">
                <button id="host-proceed-btn" class="hidden bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition-all duration-300 transform hover:scale-105">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰</button>
                <button id="host-skip-vote-btn" class="hidden bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded-lg text-sm">íˆ¬í‘œ/í–‰ë™ ê°•ì œ ì¢…ë£Œ</button>
            </div>
            <div id="timer" class="w-full flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div id="timer-text" class="text-center font-bold text-2xl mb-1">300</div>
                    <button id="host-skip-timer-btn" class="hidden bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-1 px-3 rounded-lg text-sm">í„´ ì¢…ë£Œ</button>
                </div>
                <div id="timer-bar" class="w-full bg-gray-700 rounded-full h-4">
                    <div id="timer-bar-inner" class="bg-cyan-400 h-4 rounded-full transition-all duration-1000 linear"></div>
                </div>
            </div>
             <button id="event-log-btn" class="absolute bottom-4 right-4 text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scroll-text"><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h10"/><path d="M19 17V5a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12"/><path d="M15 8h2"/><path d="M15 12h2"/><path d="M7 8h2"/><path d="M7 12h2"/></svg>
             </button>
        </div>
        <div id="observation-screen" class="screen hidden w-full max-w-4xl text-center screen-panel">
            <h1 class="title-text text-3xl sm:text-4xl font-bold mb-2">ìƒíƒœíŒ ê³µê°œ</h1>
            <p id="observation-text" class="text-lg sm:text-xl mb-4">ì¹´ë“œ ì‚¬ìš© ì‹œê°„ì…ë‹ˆë‹¤. 30ì´ˆ í›„ í˜¸ìŠ¤íŠ¸ê°€ íš¨ê³¼ë¥¼ ì ìš©í•©ë‹ˆë‹¤.</p>
            <p id="observation-timer" class="text-3xl font-bold text-yellow-400 mb-6">30</p>
            <div id="observation-player-list" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            </div>
            <div id="host-observation-controls" class="mt-4 hidden">
                <button id="host-apply-observation-cards-btn" class="btn-primary">ì¹´ë“œ íš¨ê³¼ ì ìš© ë° ì¸¡ì • ì‹œì‘</button>
            </div>
             <div id="scramble-controls" class="mt-4 hidden">
                <button id="scramble-use-btn" class="btn-primary">ëŠ¥ë ¥ ì‚¬ìš©í•˜ê¸°</button>
            </div>
        </div>
        <div id="end-result-screen" class="screen hidden w-full max-w-2xl text-center screen-panel">
            <h1 id="end-title" class="title-text text-3xl sm:text-5xl font-bold mb-8"></h1>
            <div id="final-player-list" class="space-y-2 mb-8">
            </div>
            <button id="back-to-lobby-btn" class="btn-secondary">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸° (15ì´ˆ)</button>
        </div>

        <div id="create-room-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-50 popup-overlay p-4">
            <div class="screen-panel w-full max-w-md relative popup-panel">
                <button id="close-popup-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <h2 class="title-text text-2xl font-bold text-center mb-6">ìƒˆ ê²Œì„ë°© ë§Œë“¤ê¸°</h2>
                <div class="space-y-4">
                    <input id="room-name-input" type="text" placeholder="ë°© ì´ë¦„" class="w-full bg-gray-900/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-500/50">
                    <input id="password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ ì‚¬í•­)" class="w-full bg-gray-900/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-cyan-500/50">
                </div>
                <button id="submit-create-room-btn" class="w-full mt-6 btn-primary">
                    ë§Œë“¤ê¸°
                </button>
            </div>
        </div>
        <div id="action-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-50 popup-overlay p-4">
            <div class="screen-panel w-full max-w-md text-center relative popup-panel">
                <h2 class="title-text text-2xl font-bold mb-4"></h2>
                <p class="text-lg mb-6"></p>
                <div id="action-buttons" class="flex justify-center space-x-4"></div>
            </div>
        </div>
        <div id="vote-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-50 popup-overlay p-4">
             <div class="screen-panel w-full max-w-md popup-panel">
                <h2 class="title-text text-2xl font-bold text-center mb-4"></h2>
                <p class="text-center mb-6"></p>
                <div id="vote-targets" class="space-y-2 max-h-[40vh] overflow-y-auto"></div>
            </div>
        </div>
        <div id="confirm-leave-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-50 popup-overlay p-4">
            <div class="screen-panel w-full max-w-md text-center popup-panel">
                <h2 class="title-text text-2xl font-bold text-yellow-400 mb-4">ë°© ë‚˜ê°€ê¸°</h2>
                <p class="text-lg mb-4">ì •ë§ë¡œ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <p id="leave-warning-text" class="text-red-500 font-bold mb-6 hidden"></p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-leave-btn" class="btn-secondary">ì·¨ì†Œ</button>
                    <button id="confirm-leave-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg">ë‚˜ê°€ê¸°</button>
                </div>
            </div>
        </div>
         <div id="result-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-50 popup-overlay p-4">
            <div class="screen-panel w-full max-w-lg text-center popup-panel">
                <div id="result-icon" class="mx-auto mb-4"></div>
                <p id="result-text" class="text-2xl font-bold"></p>
                <div id="result-details" class="mt-4 space-y-1"></div>
            </div>
        </div>
        <div id="rulebook-popup" class="hidden absolute inset-0 bg-black/20 flex items-center justify-center z-[100] p-4 popup-overlay">
            <div class="screen-panel w-full max-w-3xl h-[80vh] flex flex-col relative popup-panel">
                <button id="close-rulebook-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10">
                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <h2 class="title-text text-3xl font-bold text-center mb-4 flex-shrink-0">ê²Œì„ ë£°ë¶</h2>
                <div id="rulebook-content" class="flex-grow overflow-y-auto pr-4 text-lg space-y-6 text-left">
                    <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">0. ë°°ê²½ ì´ì•¼ê¸°</h3>
                        <p>ë•ŒëŠ” 1927ë…„, ë²¨ê¸°ì— ë¸Œë¤¼ì…€ì—ì„œ ì—´ë¦° ì œ5ì°¨ ì†”ë² ì´ íšŒì˜. ì•„ì¸ìŠˆíƒ€ì¸, ë‹ìŠ¤ ë³´ì–´, ë§ˆë¦¬ í€´ë¦¬ ë“± ì„¸ê³„ ìµœê³ ì˜ ì„í•™ë“¤ì´ ëª¨ì—¬ ì–‘ìì—­í•™ì˜ ë¯¸ë˜ë¥¼ ë…¼í•˜ëŠ” ì—­ì‚¬ì ì¸ ìˆœê°„, ì¸ë¥˜ì˜ ë¹„ì•½ì ì¸ ê³¼í•™ ë°œì „ì„ ì €ì§€í•˜ë ¤ëŠ” ì™¸ê³„ ì§€ì„±ì²´ 'ì—ì´ì˜¨'ì´ ë‹¹ì‹ ë“¤ ì‚¬ì´ì— ëª°ë˜ ìŠ¤íŒŒì´ë¥¼ ì ì…ì‹œì¼°ìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">1. ê²Œì„ ëª©í‘œ ë° ìŠ¹ë¦¬ ì¡°ê±´</h3>
                        <p>ì„¤ì •ëœ ë¼ìš´ë“œ(4~6)ê°€ ëª¨ë‘ ì¢…ë£Œë˜ë©´, ì‚´ì•„ë‚¨ì€ ê³¼í•™ìë“¤ì˜ ìµœì¢… ì‹ ì›ì„ 'ì¸¡ì •'í•˜ì—¬ ì¸ë¥˜ ì§„ì˜ê³¼ ì—ì´ì˜¨ ì§„ì˜ì˜ ìˆ˜ë¥¼ ë¹„êµí•˜ê³ , ìˆ˜ê°€ ë” ë§ì€ ì§„ì˜ì´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.</p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li><strong>ìµœì¢… ì¸¡ì •(Measurement)ì´ë€?</strong>: ê²Œì„ì´ ëë‚˜ë©´ ê°ìì˜ 'ì–‘ì ìƒíƒœíŒ'ì€ ì—¬ëŸ¬ ê°€ëŠ¥ì„±ì´ ì¤‘ì²©ëœ í•˜ë‚˜ì˜ í™•ë¥ ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤. 'ì¸¡ì •'ì€ ì´ ë¶ˆí™•ì‹¤í•œ ìƒíƒœë¥¼ ê´€ì¸¡í•˜ì—¬ í•˜ë‚˜ì˜ ê²°ê³¼(ì¸ë¥˜ ê³¼í•™ì ë˜ëŠ” ì—ì´ì˜¨ ìŠ¤íŒŒì´)ë¡œ í™•ì •í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ìƒíƒœíŒì˜ ë¶‰ì€ ì¹©(ì—ì´ì˜¨) ë¹„ìœ¨ì´ ë†’ì„ìˆ˜ë¡ ì¸¡ì • ì‹œ ì—ì´ì˜¨ìœ¼ë¡œ ë°í˜€ì§ˆ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</li>
                            <li><strong>ë¬´ìŠ¹ë¶€ ê·œì¹™:</strong> ë§Œì•½ ìµœì¢… ìƒì¡´ìì˜ ì¸ë¥˜ ì§„ì˜ê³¼ ì—ì´ì˜¨ ì§„ì˜ ìˆ˜ê°€ ê°™ë‹¤ë©´, ì¸ë¥˜ì˜ ê³¼í•™ ë°œì „ì„ ë§‰ìœ¼ë ¤ëŠ” ì—ì´ì˜¨ì˜ ëª©ì ì´ ì¼ë¶€ ë‹¬ì„±ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ <strong class="text-red-400">ì—ì´ì˜¨ ì§„ì˜ì˜ ìŠ¹ë¦¬</strong>ê°€ ë©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">2. ì–‘ì ìƒíƒœíŒ</h3>
                        <p>ëª¨ë“  í”Œë ˆì´ì–´ëŠ” 6ê°œì˜ ì¹©ìœ¼ë¡œ ë‹¹ì‹ ì˜ ì •ì²´ì„±ì„ ë‚˜íƒ€ë‚´ëŠ” 'ì–‘ì ìƒíƒœíŒ'ì„ ê°€ì§‘ë‹ˆë‹¤. ì´ ì¹©ì˜ ë¹„ìœ¨ì´ ë‹¹ì‹ ì˜ ìµœì¢… ì •ì²´ê°€ ë  í™•ë¥ ì…ë‹ˆë‹¤.</p>
                        <div class="flex items-center space-x-4 mt-2">
                            <div class="flex items-center space-x-2"><div class="w-5 h-5 rounded bg-blue-500 neon-blue-sm"></div><span>ì¸ë¥˜ (CITIZEN)</span></div>
                            <div class="flex items-center space-x-2"><div class="w-5 h-5 rounded bg-red-500 neon-red-sm"></div><span>ì—ì´ì˜¨ (AEON)</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">3. ì—­í•  ì†Œê°œ</h3>
                        <div class="space-y-3">
                            <p><strong class="text-orange-400">ê³¼í•™ì (Scientist):</strong> ë‹¹ì‹ ì€ ì—­ì‚¬ë¥¼ ë°”ê¿€ ìœ„ëŒ€í•œ ì§€ì„±ì…ë‹ˆë‹¤. íŠ¹ë³„í•œ ëŠ¥ë ¥ì€ ì—†ì§€ë§Œ, ë‚ ì¹´ë¡œìš´ ë…¼ë¦¬ì™€ ì¶”ë¦¬ë¡œ ë™ë£Œë“¤ ì‚¬ì´ì— ìˆ¨ì–´ë“  ì—ì´ì˜¨ ìŠ¤íŒŒì´ë¥¼ ìƒ‰ì¶œí•˜ê³  ì¸ë¥˜ ê³¼í•™ì˜ ë¯¸ë˜ë¥¼ ì§€ì¼œë‚´ì•¼ í•©ë‹ˆë‹¤.</p>
                            <p><strong class="text-orange-400">ë°±ì‹  ê°œë°œì (Developer):</strong> ë‹¹ì‹ ì€ ì—ì´ì˜¨ì˜ ì •ì‹  ê°ì—¼ì— ì €í•­í•  'ì¸ì§€ ë°±ì‹ 'ì„ ê°œë°œí•œ ì„ êµ¬ìì…ë‹ˆë‹¤. ë°¤ë§ˆë‹¤ ë™ë£Œ í•œ ëª…ì—ê²Œ ë°±ì‹ ì„ íˆ¬ì—¬í•˜ì—¬ ì—ì´ì˜¨ì˜ ê°ì—¼ìœ¼ë¡œë¶€í„° ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìì‹ ì—ê²Œë„ íˆ¬ì—¬ ê°€ëŠ¥)</p>
                            <p><strong class="text-orange-400">ì—ì´ì˜¨ (AEON):</strong> ë‹¹ì‹ ì€ ê³¼í•™ìë¡œ ìœ„ì¥í•œ ì™¸ê³„ ìŠ¤íŒŒì´ì…ë‹ˆë‹¤. ë°¤ë§ˆë‹¤ ì¸ë¥˜ ê³¼í•™ì í•œ ëª…ì˜ ì •ì‹ ì„ 'ê°ì—¼'ì‹œì¼œ, ê·¸ì˜ ìƒíƒœíŒì„ ì˜¤ì—¼ì‹œí‚¤ê³  ì¸ë¥˜ ì§„ì˜ì„ ë‹¹ì‹ ì˜ í¸ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">4. ì—­í• ì˜ ë³€í™”</h3>
                        <p>ê²Œì„ ì¤‘ ìƒíƒœíŒì˜ ëª¨ë“  ì¹©ì´ í•œ ê°€ì§€ ìƒ‰ìœ¼ë¡œ í†µì¼ë˜ë©´ ë‹¹ì‹ ì˜ ì—­í• ê³¼ ëŠ¥ë ¥ì´ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
                         <ul class="list-disc list-inside mt-2 space-y-1">
                             <li><strong class="text-red-400">ìƒˆë¡œìš´ ì—ì´ì˜¨:</strong> ìƒíƒœíŒì´ ëª¨ë‘ <span class="text-red-400">ë¹¨ê°„ìƒ‰</span>ì´ ë˜ë©´, 'ì—ì´ì˜¨'ì´ ë˜ì–´ ê°ì—¼ ëŠ¥ë ¥ì„ ì–»ìŠµë‹ˆë‹¤.</li>
                              <li><strong class="text-blue-400">ìƒˆë¡œìš´ ê°œë°œì:</strong> ìƒíƒœíŒì´ ëª¨ë‘ <span class="text-blue-400">íŒŒë€ìƒ‰</span>ì´ ë˜ë©´, 'ë°±ì‹  ê°œë°œì'ê°€ ë˜ì–´ ë³´í˜¸ ëŠ¥ë ¥ì„ ì–»ìŠµë‹ˆë‹¤.</li>
                              <li><strong class="text-gray-400">ëŠ¥ë ¥ ìƒì‹¤:</strong> ì—ì´ì˜¨/ê°œë°œìì˜€ë”ë¼ë„ ìƒíƒœíŒì— ë‹¤ë¥¸ ìƒ‰ ì¹©ì´ ìƒê¸°ë©´ ëŠ¥ë ¥ì„ ìƒê³  ì¼ë°˜ 'ê³¼í•™ì'ê°€ ë©ë‹ˆë‹¤.</li>
                         </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">5. ê²Œì„ ì§„í–‰: ë‚®ê³¼ ë°¤</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-xl text-yellow-300 mb-1">ğŸŒ ë‚®: ì¸ì§€ ì¹˜ë£Œ</h4>
                                <p>5ë¶„ê°„ í† ë¡  í›„, ëª¨ë“  ìƒì¡´ìëŠ” <strong class="text-yellow-300">'ì¸ì§€ ì¹˜ë£Œì œ'</strong>ë¥¼ íˆ¬ì—¬í•  1ëª…ì„ íˆ¬í‘œí•©ë‹ˆë‹¤. ì¹˜ë£Œì œëŠ” ê°ì—¼ëœ <span class="text-red-400">ì—ì´ì˜¨ ì¹©</span> 1ê°œë¥¼ <span class="text-blue-400">ì¸ë¥˜ ì¹©</span>ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤. ë™ì  ì‹œ 1ëª…ì´ ë½‘í ë•Œê¹Œì§€ ì¬íˆ¬í‘œí•©ë‹ˆë‹¤.</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-xl text-indigo-300 mb-1">ğŸŒš ë°¤: ë¹„ë°€ í™œë™</h4>
                                <p>ì—ì´ì˜¨ì€ <strong class="text-indigo-300">'ì •ì‹  ê°ì—¼'</strong> ëŒ€ìƒì„, ê°œë°œìëŠ” <strong class="text-indigo-300">'ì¸ì§€ ë°±ì‹ '</strong> íˆ¬ì—¬ ëŒ€ìƒì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
                                <ul class="list-disc list-inside mt-2 space-y-2 pl-2">
                                    <li><strong class="text-red-400">ê°ì—¼:</strong> ëŒ€ìƒì˜ <span class="text-blue-400">íŒŒë€ ì¹©</span> 1ê°œê°€ <span class="text-red-400">ë¹¨ê°„ ì¹©</span>ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.</li>
                                    <li><strong class="text-blue-400">ë°±ì‹ :</strong> ê·¸ í„´ì— ëŒ€ìƒì—ê²Œ ê°€í•´ì§€ëŠ” <strong class="text-red-400">ëª¨ë“  ê°ì—¼ ì‹œë„</strong>ë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-bold text-2xl text-cyan-300 mb-2 font-orbitron">6. ì¹´ì˜¤ìŠ¤ ëª¨ë“œ ì¹´ë“œ ì‚¬ìš©ë²•</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-xl text-yellow-300">ì •ë³´ì „ ì¹´ë“œ</h4>
                                <p><strong>í•˜ì´ì  ë² ë¥´í¬ ê´€ì¸¡ê¸°:</strong> 'ë‚® í† ë¡ ' ì‹œê°„ì— ì‚¬ìš©. ë‹¤ë¥¸ í”Œë ˆì´ì–´ 1ëª…ì˜ ìƒíƒœíŒì„ ì •í™•í•˜ê²Œ í™•ì¸í•˜ëŠ” ëŒ€ê°€(ë¶ˆí™•ì •ì„± ì›ë¦¬)ë¡œ, ìì‹ ì˜ ìƒíƒœíŒ ì¹© í•˜ë‚˜ê°€ ë¬´ì‘ìœ„ë¡œ ë°˜ëŒ€ ìƒ‰ìœ¼ë¡œ ë’¤ì§‘í™ë‹ˆë‹¤.</p>
                                <p><strong>ì•”í˜¸ í•´ë…ê¸°:</strong> 'ë‚® í† ë¡ ' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. 'ì‚¬ìš©í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ì˜ˆì•½ë˜ë©°, ë°¤ì´ ëë‚œ í›„ ëª¨ë“  ëŠ¥ë ¥ ì‚¬ìš© ê²°ê³¼ê°€ ìš”ì•½ëœ íŒì—…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-xl text-yellow-300">ìƒíƒœ ë³€ê²½ ì¹´ë“œ</h4>
                                <p><strong>ë°ì´í„° ì˜¤ì—¼/ë³µêµ¬:</strong> 'ë‚® í† ë¡ ' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. ëŒ€ìƒì„ 1ëª… ì„ íƒí•˜ë©´(ìì‹  í¬í•¨ ê°€ëŠ¥), ì¦‰ì‹œ ëŒ€ìƒì˜ ì¹© ìƒ‰ê¹” 1ê°œê°€ ë³€ê²½ë©ë‹ˆë‹¤.</p>
                                <p><strong>ì‹ ë¶„ êµë€ ì¥ì¹˜:</strong> ê²Œì„ ì¢…ë£Œ í›„ 'ìƒíƒœíŒ ê³µê°œ' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. ëŒ€ìƒì„ 1ëª… ì„ íƒí•˜ë©´, ìµœì¢… ìš´ëª… ì¸¡ì • ì§ì „ì— ëŒ€ìƒê³¼ ìì‹ ì˜ ìƒíƒœíŒ ì „ì²´ê°€ ì„œë¡œ êµì²´ë©ë‹ˆë‹¤.</p>
                                <p><strong>ìˆ™ì£¼ í”„ë¡œí† ì½œ:</strong> (íŒ¨ì‹œë¸Œ) ë³„ë„ ì‚¬ìš©ë²• ì—†ìŒ. ë°¤ ì¢…ë£Œ ì‹œì ì— ì—ì´ì˜¨ì´ í•œ ëª…ë„ ì—†ìœ¼ë©´ ì¹´ë“œë¥¼ ê°€ì§„ ì‚¬ëŒì´ ìë™ìœ¼ë¡œ ì—ì´ì˜¨ì´ ë˜ê³ , ë¬´ì‘ìœ„ 1ëª…ì„ ì¶”ê°€ ê°ì—¼ì‹œí‚µë‹ˆë‹¤.</p>
                                <p><strong>ë¶„ì—´ ë³€ì¢…:</strong> 'ë°¤ í–‰ë™' ì‹œê°„ì— ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤. ìì‹ ì´ ì—ì´ì˜¨ì´ë¼ë©´ ê°ì—¼ ëŒ€ìƒì„ 2ëª…ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-xl text-yellow-300">ê·œì¹™ ì¡°ì‘ ì¹´ë“œ</h4>
                                <p><strong>ì–‘ì ì–½í˜:</strong> 'ë‚® í† ë¡ ' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. ëŒ€ìƒì„ 1ëª… ì„ íƒí•˜ë©´ ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ë‘ ì‚¬ëŒì´ ì–½í˜”ìŒì´ ê³µì§€ë©ë‹ˆë‹¤. ì´ë•Œë¶€í„° ë‘ ì‚¬ëŒì€ ê²Œì„ ì¢…ë£Œ ì‹œ ë°˜ë“œì‹œ ì„œë¡œ ë‹¤ë¥¸ ì§„ì˜ì´ ë˜ì–´ì•¼ë§Œ ìŠ¹ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <p><strong>ì¸ê³¼ìœ¨ êµë€ê¸°:</strong> 'ìµœì¢… ì¸¡ì •' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. ìì‹ ì˜ ìµœì¢… ì—­í• ì´ ê²°ì •ëœ í›„, ìƒíƒœíŒ ì•„ë˜ì— 'ì¬ì¸¡ì •' ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¬ì¸¡ì •ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <p><strong>ë°©í™”ë²½:</strong> 'ë‚® í† ë¡ ' ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥. 'ì‚¬ìš©í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ë‹¤ê°€ì˜¤ëŠ” ë°¤ ë™ì•ˆ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê°ì—¼ ëŠ¥ë ¥ìœ¼ë¡œë¶€í„° ë³´í˜¸ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="custom-alert-popup" class="hidden absolute inset-0 bg-black/60 flex items-center justify-center z-[101] popup-overlay">
            <div class="screen-panel w-full max-w-md text-center popup-panel">
                <h2 class="title-text text-2xl font-bold mb-4 text-yellow-400">ì•Œë¦¼</h2>
                <div id="custom-alert-text" class="text-lg mb-6"></div>
                <button id="close-custom-alert-btn" class="btn-primary">í™•ì¸</button>
            </div>
        </div>
        <div id="event-log-popup" class="hidden absolute inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 popup-overlay">
            <div class="screen-panel w-full max-w-2xl h-[70vh] flex flex-col relative popup-panel">
                 <button id="close-event-log-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                 </button>
                <h2 class="title-text text-3xl font-bold text-center mb-4 flex-shrink-0">ì‚¬ê±´ ê¸°ë¡</h2>
                <div id="event-log-content" class="flex-grow overflow-y-auto pr-4 text-lg space-y-3">
                </div>
            </div>
        </div>

         <!-- ì—­í•  ê³µê°œ íŒì—… -->
        <div id="role-reveal-popup" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-[102] popup-overlay">
            <div id="role-reveal-card" class="screen-panel w-full max-w-sm text-center popup-panel border-2 border-yellow-300 shadow-2xl shadow-yellow-300/50">
                <p class="text-yellow-300 text-sm font-bold tracking-widest">AGENT IDENTIFICATION</p>
                <h2 id="role-reveal-name" class="title-text text-4xl font-bold my-4"></h2>
                <div class="glitch-line"></div>
                <p class="text-gray-400 mb-2">INITIALIZING ROLE...</p>
                <p id="role-reveal-text" class="text-2xl font-bold text-white"></p>
            </div>
        </div>

        <!-- ë‹¨ê³„ ì „í™˜ ì˜¤ë²„ë ˆì´ -->
        <div id="phase-transition-overlay" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-[103] pointer-events-none">
            <p id="phase-transition-text" class="title-text text-3xl animate-pulse-slow"></p>
        </div>

        <!-- ì¹´ë“œ ì‚¬ìš© íš¨ê³¼ ì˜¤ë²„ë ˆì´ -->
        <div id="card-effect-overlay" class="hidden absolute inset-0 bg-black/90 flex-col items-center justify-center z-[104] pointer-events-none">
            <h2 id="card-effect-name" class="title-text text-4xl animate-pulse-slow"></h2>
            <div class="glitch-line w-1/2 my-4"></div>
            <p id="card-effect-subtitle" class="text-xl text-yellow-300"></p>
        </div>
    </div>
</body>
</html>

